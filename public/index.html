<!DOCTYPE html>
<!--
    Smart Library Platform - Frontend Application
    
    Features:
    - User authentication and authorization
    - Book browsing and advanced search
    - Book borrowing and returning system
    - Review and rating functionality
    - Real-time availability tracking
    - Admin dashboard and analytics
    
    Security:
    - Content Security Policy (CSP) compliant
    - Event delegation for all user interactions
    - Secure API communication with JWT tokens
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Library Platform</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .navbar-nav .nav-link {
            color: white !important;
            transition: all 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: var(--warning-color) !important;
            transform: translateY(-1px);
        }
        
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 4rem 0;
            text-align: center;
        }
        
        .hero-section h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .hero-section p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }
        
        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: none;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .feature-icon {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border: none;
            border-radius: 25px;
            padding: 0.7rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            border-radius: 25px;
            padding: 0.7rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .section-title {
            text-align: center;
            margin: 3rem 0;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stats-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .stat-label {
            font-size: 1rem;
            color: var(--dark-text);
            opacity: 0.8;
        }
        
        .footer {
            background: var(--primary-color);
            color: white;
            padding: 3rem 0 1rem;
            margin-top: 4rem;
        }
        
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .book-cover {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .rating {
            color: var(--warning-color);
        }
        
        .availability-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner-border {
            color: var(--secondary-color);
        }
        
        /* Rating Stars Styles */
        .rating-input .stars {
            display: inline-block;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .rating-input .stars i {
            color: #ddd;
            transition: color 0.2s ease;
            margin-right: 0.2rem;
        }
        
        .rating-input .stars i:hover,
        .rating-input .stars i.active {
            color: #ffc107;
        }
        
        .rating-input .stars i.fas {
            color: #ffc107;
        }
        
        /* Checkout Status Styles */
        .checkout-status {
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .checkout-status.on-time {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .checkout-status.late {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .checkout-status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        @media (max-width: 768px) {
            .hero-section h1 {
                font-size: 2rem;
            }
            
            .hero-section p {
                font-size: 1rem;
            }
            
            .feature-card {
                margin: 0.5rem;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#" id="navBrand">
                <i class="fas fa-book-open me-2"></i>Smart Library
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="navBooks">
                            <i class="fas fa-book me-1"></i>Books
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="navAnalytics">
                            <i class="fas fa-chart-bar me-1"></i>Analytics
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav" id="authNavItems">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">
                            <i class="fas fa-sign-in-alt me-1"></i>Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#registerModal">
                            <i class="fas fa-user-plus me-1"></i>Register
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav d-none" id="userNavItems">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i><span id="userName">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="navDashboard"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a></li>
                            <li><a class="dropdown-item" href="#" id="navCheckouts"><i class="fas fa-bookmark me-2"></i>My Checkouts</a></li>
                            <li><a class="dropdown-item" href="#" id="navReviews"><i class="fas fa-star me-2"></i>My Reviews</a></li>
                            <li id="adminNavItem" class="d-none"><hr class="dropdown-divider"></li>
                            <li id="adminNavItem2" class="d-none"><a class="dropdown-item" href="#" id="navAdmin"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="navLogout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Notification Container -->
    <div id="notificationContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050; max-width: 400px;">
        <!-- Notifications will be dynamically added here -->
    </div>

    <!-- Main Content -->
    <main id="mainContent">
        <!-- Hero Section -->
        <section class="hero-section" id="heroSection">
            <div class="container">
                <h1>Welcome to Smart Library Platform</h1>
                <p>Discover, borrow, and explore thousands of books with our intelligent library management system</p>
                <div>
                    <button class="btn btn-light btn-lg me-3" id="exploreButton">
                        <i class="fas fa-compass me-2"></i>Explore Books
                    </button>
                    <button class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#registerModal">
                        <i class="fas fa-user-plus me-2"></i>Join Today
                    </button>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="container my-5" id="featuresSection">
            <h2 class="section-title">Platform Features</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="feature-card text-center">
                        <i class="fas fa-search feature-icon"></i>
                        <h4>Smart Search</h4>
                        <p>Find books by title, author, genre, or keywords with our advanced search functionality.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-card text-center">
                        <i class="fas fa-mobile-alt feature-icon"></i>
                        <h4>Digital Reading</h4>
                        <p>Access eBooks on any device with reading session tracking and analytics.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-card text-center">
                        <i class="fas fa-star feature-icon"></i>
                        <h4>Reviews & Ratings</h4>
                        <p>Share your thoughts and discover great books through community reviews.</p>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="feature-card text-center">
                        <i class="fas fa-chart-line feature-icon"></i>
                        <h4>Reading Analytics</h4>
                        <p>Track your reading habits and get personalized book recommendations.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-card text-center">
                        <i class="fas fa-bookmark feature-icon"></i>
                        <h4>Easy Checkout</h4>
                        <p>Borrow books instantly and manage your reading list with ease.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-card text-center">
                        <i class="fas fa-users feature-icon"></i>
                        <h4>Community</h4>
                        <p>Connect with fellow readers and discover trending books in the community.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="container" id="statsSection">
            <div class="stats-section">
                <div class="row">
                    <div class="col-md-3 stat-item">
                        <div class="stat-number" id="totalBooks">0</div>
                        <div class="stat-label">Books Available</div>
                    </div>
                    <div class="col-md-3 stat-item">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Active Readers</div>
                    </div>
                    <div class="col-md-3 stat-item">
                        <div class="stat-number" id="totalCheckouts">0</div>
                        <div class="stat-label">Books Borrowed</div>
                    </div>
                    <div class="col-md-3 stat-item">
                        <div class="stat-number" id="totalReviews">0</div>
                        <div class="stat-label">Reviews Written</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">
                        <i class="fas fa-sign-in-alt me-2"></i>Login to Your Account
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">Username or Email</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div id="loginError" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">
                        <i class="fas fa-user-plus me-2"></i>Create New Account
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="registerFirstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="registerFirstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="registerLastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="registerLastName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="registerUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                            <div class="form-text">Password must be at least 8 characters long.</div>
                        </div>
                        <div class="mb-3">
                            <label for="registerPhone" class="form-label">Phone (Optional)</label>
                            <input type="tel" class="form-control" id="registerPhone">
                        </div>
                        <div id="registerError" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-user-plus me-2"></i>Create Account
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-book-open me-2"></i>Smart Library Platform</h5>
                    <p>A modern library management system with advanced features for readers and staff.</p>
                </div>
                <div class="col-md-6">
                    <h5>Features</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check me-2"></i>Book Search & Discovery</li>
                        <li><i class="fas fa-check me-2"></i>Digital Reading Analytics</li>
                        <li><i class="fas fa-check me-2"></i>Review System</li>
                        <li><i class="fas fa-check me-2"></i>Admin Dashboard</li>
                    </ul>
                </div>
            </div>
            <hr class="my-4">
            <div class="text-center">
                <p>&copy; 2025 Smart Library Platform. Built by Lu Duc Thinh</p>
            </div>
        </div>
    </footer>

    <!-- Borrow Book Modal -->
    <div class="modal fade" id="borrowModal" tabindex="-1" aria-labelledby="borrowModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="borrowModalLabel">
                        <i class="fas fa-bookmark me-2"></i>Borrow Book
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="borrowForm">
                        <input type="hidden" id="borrowBookId">
                        <div class="mb-3">
                            <label class="form-label">Book Title</label>
                            <input type="text" class="form-control" id="borrowBookTitle" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Borrow Duration</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <select class="form-select" id="loanPeriod">
                                        <option value="7">7 days</option>
                                        <option value="14" selected>14 days</option>
                                        <option value="21">21 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <input type="date" class="form-control" id="dueDatePicker" />
                                </div>
                            </div>
                            <div class="form-text">Pick either a duration or a due date (max 30 days).</div>
                        </div>
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Important:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>You can borrow up to 5 books at a time</li>
                                    <li>Late returns may incur fees</li>
                                    <li>You'll receive email reminders before the due date</li>
                                </ul>
                            </div>
                        </div>
                        <div id="borrowError" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-bookmark me-2"></i>Confirm Borrow
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Return Book Modal -->
    <div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="returnModalLabel">
                        <i class="fas fa-undo me-2"></i>Return Book
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="returnForm">
                        <input type="hidden" id="returnBookId">
                        <div class="mb-3">
                            <label class="form-label">Book Title</label>
                            <input type="text" class="form-control" id="returnBookTitle" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="text" class="form-control" id="returnDueDate" readonly>
                        </div>
                        <div class="mb-3">
                            <div id="returnStatus" class="alert">
                                <!-- Status will be populated by JavaScript -->
                            </div>
                        </div>
                        <div id="returnError" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fas fa-undo me-2"></i>Confirm Return
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Book Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewModalLabel">
                        <i class="fas fa-star me-2"></i>Review Book
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reviewForm">
                        <input type="hidden" id="reviewBookId">
                        <div class="mb-3">
                            <label class="form-label">Book Title</label>
                            <input type="text" class="form-control" id="reviewBookTitle" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="reviewRating" class="form-label">Rating</label>
                            <div class="rating-input">
                                <div class="stars">
                                    <i class="far fa-star" data-rating="1"></i>
                                    <i class="far fa-star" data-rating="2"></i>
                                    <i class="far fa-star" data-rating="3"></i>
                                    <i class="far fa-star" data-rating="4"></i>
                                    <i class="far fa-star" data-rating="5"></i>
                                </div>
                                <input type="hidden" id="reviewRating" required>
                                <div class="form-text">Click on the stars to rate this book.</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reviewComment" class="form-label">Comment (Optional)</label>
                            <textarea class="form-control" id="reviewComment" rows="4" maxlength="1000" placeholder="Share your thoughts about this book..."></textarea>
                            <div class="form-text">Maximum 1000 characters</div>
                        </div>
                        <div id="reviewError" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-info w-100">
                            <i class="fas fa-star me-2"></i>Submit Review
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Application JavaScript -->
    <script>
        /**
         * Smart Library Platform - Frontend JavaScript
         * 
         * Architecture:
         * - App: Global application state
         * - Utils: Utility functions for API calls and helpers  
         * - Auth: Authentication related functions
         * - UI: User interface management and rendering
         * 
         * Event Handling:
         * - Uses event delegation for CSP compliance
         * - All user interactions handled through centralized listeners
         */

        // ============================================================================
        // APPLICATION STATE
        // ============================================================================
        
        /**
         * Global application state
         * @namespace App
         */
        const App = {
            /** @type {Object|null} Current authenticated user */
            user: null,
            /** @type {string|null} JWT authentication token */
            token: localStorage.getItem('library_token'),
            /** @type {string} Base API URL for all requests */
            baseURL: window.location.origin + '/api'
        };

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        const Utils = {
            showAlert: (message, type = 'danger', containerId = 'alertContainer') => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                }
            },

            formatDate: (dateString) => {
                return new Date(dateString).toLocaleDateString();
            },

            generateStarRating: (rating) => {
                const fullStars = Math.floor(rating);
                const hasHalfStar = rating % 1 !== 0;
                let stars = '';
                
                for (let i = 0; i < fullStars; i++) {
                    stars += '<i class="fas fa-star text-warning"></i>';
                }
                
                if (hasHalfStar) {
                    stars += '<i class="fas fa-star-half-alt text-warning"></i>';
                }
                
                const remainingStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                for (let i = 0; i < remainingStars; i++) {
                    stars += '<i class="far fa-star text-warning"></i>';
                }
                
                return stars;
            },

            makeRequest: async (endpoint, options = {}) => {
                const url = `${App.baseURL}${endpoint}`;
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (App.token) {
                    defaultOptions.headers['Authorization'] = `Bearer ${App.token}`;
                }

                const response = await fetch(url, { ...defaultOptions, ...options });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || 'Request failed');
                }

                return data;
            }
        };

        // ============================================================================
        // AUTHENTICATION FUNCTIONS
        // ============================================================================
        const Auth = {
            login: async (username, password) => {
                try {
                    const data = await Utils.makeRequest('/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ username, password })
                    });

                    App.token = data.token;
                    App.user = data.user;
                    localStorage.setItem('library_token', data.token);
                    
                    UI.updateAuthState();
                    await UI.loadUserData();
                    UI.showHomePage();
                    
                    // Close login modal
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    loginModal.hide();

                    Utils.showAlert('Login successful!', 'success');
                } catch (error) {
                    document.getElementById('loginError').textContent = error.message;
                    document.getElementById('loginError').classList.remove('d-none');
                }
            },

            register: async (userData) => {
                try {
                    const data = await Utils.makeRequest('/auth/register', {
                        method: 'POST',
                        body: JSON.stringify(userData)
                    });

                    App.token = data.token;
                    App.user = data.user;
                    localStorage.setItem('library_token', data.token);
                    
                    UI.updateAuthState();
                    await UI.loadUserData();
                    UI.showHomePage();
                    
                    // Close register modal
                    const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
                    registerModal.hide();

                    Utils.showAlert('Registration successful! Welcome to Smart Library!', 'success');
                } catch (error) {
                    document.getElementById('registerError').textContent = error.message;
                    document.getElementById('registerError').classList.remove('d-none');
                }
            },

            logout: () => {
                App.token = null;
                App.user = null;
                localStorage.removeItem('library_token');
                UI.updateAuthState();
                UI.showHomePage();
                Utils.showAlert('Logged out successfully!', 'info');
            },

            checkAuth: async () => {
                if (App.token) {
                    try {
                        const data = await Utils.makeRequest('/auth/profile');
                        App.user = data.user;
                        UI.updateAuthState();
                        await UI.loadUserData();
                    } catch (error) {
                        Auth.logout();
                    }
                }
            }
        };

        // ============================================================================
        // USER INTERFACE FUNCTIONS
        // ============================================================================
        const UI = {
            // Generate beautiful book covers inspired by real covers
            getPlaceholderImage: (title, size, genre = 'Fiction') => {
                const [width, height] = size.split('x');
                
                // Book-specific designs inspired by real covers from user's images
                const bookCovers = {
                    '1984': {
                        bgColor: '#2c3e50',
                        accentColor: '#e74c3c',
                        pattern: 'dystopian',
                        title: '1984',
                        subtitle: 'GEORGE ORWELL',
                        style: 'propaganda'
                    },
                    'Atomic Habits': {
                        bgColor: '#ffffff',
                        accentColor: '#ff6b35',
                        pattern: 'dots',
                        title: 'ATOMIC',
                        subtitle: 'HABITS',
                        style: 'modern'
                    },
                    'Clean Code': {
                        bgColor: '#1a1a2e',
                        accentColor: '#00d4ff',
                        pattern: 'galaxy',
                        title: 'CLEAN CODE',
                        subtitle: 'ROBERT C. MARTIN',
                        style: 'space'
                    },
                    'Designing Data-Intensive Applications': {
                        bgColor: '#e74c3c',
                        accentColor: '#ffffff',
                        pattern: 'animal',
                        title: 'DESIGNING',
                        subtitle: 'DATA-INTENSIVE',
                        style: 'oreilly'
                    },
                    'Dune': {
                        bgColor: '#000000',
                        accentColor: '#ffffff',
                        pattern: 'desert',
                        title: 'DUNE',
                        subtitle: 'FRANK HERBERT',
                        style: 'minimal'
                    },
                    'Educated': {
                        bgColor: '#f5f5dc',
                        accentColor: '#8b4513',
                        pattern: 'pencil',
                        title: 'EDUCATED',
                        subtitle: 'TARA WESTOVER',
                        style: 'memoir'
                    },
                    'Harry Potter and the Philosopher\'s Stone': {
                        bgColor: '#8b4513',
                        accentColor: '#ffd700',
                        pattern: 'magic',
                        title: 'HARRY POTTER',
                        subtitle: 'J.K. ROWLING',
                        style: 'fantasy'
                    },
                    'Pride and Prejudice': {
                        bgColor: '#e74c3c',
                        accentColor: '#ffffff',
                        pattern: 'bridge',
                        title: 'PRIDE &',
                        subtitle: 'PREJUDICE',
                        style: 'classic'
                    },
                    'Sapiens: A Brief History of Humankind': {
                        bgColor: '#ffffff',
                        accentColor: '#e74c3c',
                        pattern: 'fingerprint',
                        title: 'SAPIENS',
                        subtitle: 'YUVAL NOAH HARARI',
                        style: 'modern'
                    },
                    'The Catcher in the Rye': {
                        bgColor: '#ff8c00',
                        accentColor: '#ffffff',
                        pattern: 'carousel',
                        title: 'THE CATCHER',
                        subtitle: 'IN THE RYE',
                        style: 'vintage'
                    },
                    'The Great Gatsby': {
                        bgColor: '#1e3a8a',
                        accentColor: '#ffffff',
                        pattern: 'eyes',
                        title: 'THE GREAT',
                        subtitle: 'GATSBY',
                        style: 'artdeco'
                    },
                    'The Hobbit': {
                        bgColor: '#000000',
                        accentColor: '#ffd700',
                        pattern: 'mountains',
                        title: 'THE HOBBIT',
                        subtitle: 'J.R.R. TOLKIEN',
                        style: 'fantasy'
                    },
                    'The Lord of the Rings: The Fellowship of the Ring': {
                        bgColor: '#000000',
                        accentColor: '#ffd700',
                        pattern: 'ring',
                        title: 'THE FELLOWSHIP',
                        subtitle: 'OF THE RING',
                        style: 'epic'
                    },
                    'The Midnight Library': {
                        bgColor: '#1e3a8a',
                        accentColor: '#ffffff',
                        pattern: 'library',
                        title: 'THE MIDNIGHT',
                        subtitle: 'LIBRARY',
                        style: 'magical'
                    },
                    'The Pragmatic Programmer': {
                        bgColor: '#000000',
                        accentColor: '#ffffff',
                        pattern: 'tool',
                        title: 'THE PRAGMATIC',
                        subtitle: 'PROGRAMMER',
                        style: 'professional'
                    },
                    'The Seven Husbands of Evelyn Hugo': {
                        bgColor: '#27ae60',
                        accentColor: '#ffffff',
                        pattern: 'glamour',
                        title: 'THE SEVEN',
                        subtitle: 'HUSBANDS',
                        style: 'hollywood'
                    },
                    'The Silent Patient': {
                        bgColor: '#f5f5dc',
                        accentColor: '#c0392b',
                        pattern: 'face',
                        title: 'THE SILENT',
                        subtitle: 'PATIENT',
                        style: 'thriller'
                    },
                    'To Kill a Mockingbird': {
                        bgColor: '#8b4513',
                        accentColor: '#ffffff',
                        pattern: 'tree',
                        title: 'TO KILL A',
                        subtitle: 'MOCKINGBIRD',
                        style: 'classic'
                    },
                    'Where the Crawdads Sing': {
                        bgColor: '#ff8c00',
                        accentColor: '#ffffff',
                        pattern: 'marsh',
                        title: 'WHERE THE',
                        subtitle: 'CRAWDADS SING',
                        style: 'nature'
                    },
                    'You Don\'t Know JS: Scope & Closures': {
                        bgColor: '#2c3e50',
                        accentColor: '#f39c12',
                        pattern: 'code',
                        title: 'YOU DON\'T',
                        subtitle: 'KNOW JS',
                        style: 'tech'
                    }
                };
                
                // Find the book by title (case-insensitive)
                let design = null;
                for (const [bookTitle, cover] of Object.entries(bookCovers)) {
                    if (bookTitle.toLowerCase() === title.toLowerCase()) {
                        design = cover;
                        break;
                    }
                }
                
                // Fallback to genre-based design
                if (!design) {
                    const genreDesigns = {
                        'Information Technology': { bgColor: '#2c3e50', accentColor: '#3498db', pattern: 'tech', title: 'TECH', subtitle: 'BOOK' },
                        'Science Fiction': { bgColor: '#8e44ad', accentColor: '#e74c3c', pattern: 'space', title: 'SCI-FI', subtitle: 'BOOK' },
                        'Fantasy': { bgColor: '#27ae60', accentColor: '#f39c12', pattern: 'magic', title: 'FANTASY', subtitle: 'BOOK' },
                        'Romance': { bgColor: '#e74c3c', accentColor: '#f8c9d4', pattern: 'hearts', title: 'ROMANCE', subtitle: 'BOOK' },
                        'Classic Literature': { bgColor: '#8b4513', accentColor: '#daa520', pattern: 'classic', title: 'CLASSIC', subtitle: 'BOOK' },
                        'Fiction': { bgColor: '#34495e', accentColor: '#95a5a6', pattern: 'modern', title: 'FICTION', subtitle: 'BOOK' },
                        'Dystopian Fiction': { bgColor: '#2c3e50', accentColor: '#e74c3c', pattern: 'dystopian', title: 'DYSTOPIA', subtitle: 'BOOK' },
                        'Non-fiction': { bgColor: '#2980b9', accentColor: '#ecf0f1', pattern: 'academic', title: 'NON-FICTION', subtitle: 'BOOK' },
                        'Coming-of-age Fiction': { bgColor: '#e67e22', accentColor: '#f39c12', pattern: 'youth', title: 'COMING-OF-AGE', subtitle: 'BOOK' },
                        'Mystery': { bgColor: '#2c3e50', accentColor: '#e74c3c', pattern: 'mystery', title: 'MYSTERY', subtitle: 'BOOK' },
                        'Historical Fiction': { bgColor: '#8b4513', accentColor: '#daa520', pattern: 'historical', title: 'HISTORICAL', subtitle: 'BOOK' },
                        'Thriller': { bgColor: '#c0392b', accentColor: '#e74c3c', pattern: 'thriller', title: 'THRILLER', subtitle: 'BOOK' },
                        'Memoir': { bgColor: '#16a085', accentColor: '#1abc9c', pattern: 'personal', title: 'MEMOIR', subtitle: 'BOOK' },
                        'Self-Help': { bgColor: '#27ae60', accentColor: '#2ecc71', pattern: 'growth', title: 'SELF-HELP', subtitle: 'BOOK' }
                    };
                    
                    // Try to find genre from the book title or use default
                    let foundGenre = 'Fiction';
                    for (const [genreName, genreDesign] of Object.entries(genreDesigns)) {
                        if (genre.toLowerCase().includes(genreName.toLowerCase()) || 
                            genreName.toLowerCase().includes(genre.toLowerCase())) {
                            foundGenre = genreName;
                            break;
                        }
                    }
                    design = genreDesigns[foundGenre] || { bgColor: '#7f8c8d', accentColor: '#95a5a6', pattern: 'default', title: 'BOOK', subtitle: 'STORY' };
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = parseInt(width);
                canvas.height = parseInt(height);
                const ctx = canvas.getContext('2d');
                
                // Create beautiful background
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, design.bgColor);
                gradient.addColorStop(1, UI.darkenColor(design.bgColor, 20));
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add pattern-specific elements based on real book covers
                ctx.fillStyle = design.accentColor;
                ctx.globalAlpha = 0.6;
                
                if (design.style === 'propaganda') {
                    // 1984 style - dark with red accents
                    ctx.fillStyle = '#e74c3c';
                    for (let i = 0; i < 10; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 3, 3);
                    }
                } else if (design.style === 'modern') {
                    // Atomic Habits style - white background with orange dots
                    if (design.pattern === 'dots') {
                        for (let i = 0; i < 50; i++) {
                            const x = Math.random() * canvas.width;
                            const y = Math.random() * canvas.height;
                            const size = Math.random() * 4 + 2;
                            ctx.fillRect(x, y, size, size);
                        }
                    } else if (design.pattern === 'fingerprint') {
                        // Sapiens style - fingerprint pattern
                        for (let i = 0; i < 30; i++) {
                            const x = Math.random() * canvas.width;
                            const y = Math.random() * canvas.height;
                            ctx.fillRect(x, y, 2, 2);
                        }
                    }
                } else if (design.style === 'space') {
                    // Clean Code style - galaxy background
                    for (let i = 0; i < 40; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        const size = Math.random() * 3 + 1;
                        ctx.fillRect(x, y, size, size);
                    }
                } else if (design.style === 'minimal') {
                    // Dune style - minimal with stars
                    for (let i = 0; i < 25; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 2, 2);
                    }
                } else if (design.style === 'fantasy') {
                    // Harry Potter and Hobbit style - magical elements
                    for (let i = 0; i < 30; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 3, 3);
                    }
                } else if (design.style === 'classic') {
                    // Classic literature style
                    if (design.pattern === 'tree') {
                        // To Kill a Mockingbird style - tree leaves
                        ctx.fillStyle = '#27ae60';
                        for (let i = 0; i < 20; i++) {
                            const x = Math.random() * canvas.width;
                            const y = Math.random() * canvas.height;
                            ctx.fillRect(x, y, 4, 4);
                        }
                    }
                } else if (design.style === 'vintage') {
                    // The Catcher in the Rye style - vintage orange
                    for (let i = 0; i < 15; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 3, 3);
                    }
                } else if (design.style === 'artdeco') {
                    // The Great Gatsby style - art deco elements
                    for (let i = 0; i < 20; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 2, 2);
                    }
                } else if (design.style === 'epic') {
                    // Lord of the Rings style - epic fantasy
                    for (let i = 0; i < 25; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 3, 3);
                    }
                } else if (design.style === 'magical') {
                    // The Midnight Library style - magical library
                    for (let i = 0; i < 35; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 2, 2);
                    }
                } else if (design.style === 'professional') {
                    // The Pragmatic Programmer style - professional
                    for (let i = 0; i < 10; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 2, 2);
                    }
                } else if (design.style === 'hollywood') {
                    // The Seven Husbands of Evelyn Hugo style - glamour
                    for (let i = 0; i < 15; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 3, 3);
                    }
                } else if (design.style === 'thriller') {
                    // The Silent Patient style - thriller
                    for (let i = 0; i < 12; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 2, 2);
                    }
                } else if (design.style === 'nature') {
                    // Where the Crawdads Sing style - nature
                    for (let i = 0; i < 18; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 3, 3);
                    }
                } else if (design.style === 'tech') {
                    // You Don't Know JS style - tech
                    for (let i = 0; i < 20; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        ctx.fillRect(x, y, 2, 2);
                    }
                }
                
                ctx.globalAlpha = 1.0;
                
                // Add title area based on real book cover styles
                if (design.style === 'modern' && design.pattern === 'dots') {
                    // Atomic Habits style - no white background, just dots
                    ctx.fillStyle = design.accentColor;
                    ctx.font = `bold ${Math.max(16, Math.min(canvas.width / 10, 24))}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(design.title, canvas.width / 2, canvas.height * 0.4);
                    ctx.fillText(design.subtitle, canvas.width / 2, canvas.height * 0.5);
                } else if (design.style === 'minimal') {
                    // Dune style - minimal with large title
                    ctx.fillStyle = design.accentColor;
                    ctx.font = `bold ${Math.max(20, Math.min(canvas.width / 8, 28))}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(design.title, canvas.width / 2, canvas.height * 0.5);
                    ctx.font = `${Math.max(12, Math.min(canvas.width / 12, 16))}px Arial`;
                    ctx.fillText(design.subtitle, canvas.width / 2, canvas.height * 0.7);
                } else if (design.style === 'fantasy') {
                    // Harry Potter and Hobbit style - elegant titles
                    ctx.fillStyle = design.accentColor;
                    ctx.font = `bold ${Math.max(14, Math.min(canvas.width / 10, 20))}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(design.title, canvas.width / 2, canvas.height * 0.4);
                    ctx.font = `${Math.max(10, Math.min(canvas.width / 14, 14))}px Arial`;
                    ctx.fillText(design.subtitle, canvas.width / 2, canvas.height * 0.5);
                } else if (design.style === 'classic') {
                    // Classic literature style - elegant white area
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(canvas.width * 0.1, canvas.height * 0.6, canvas.width * 0.8, canvas.height * 0.3);
                    
                    ctx.fillStyle = design.bgColor;
                    ctx.font = `bold ${Math.max(12, Math.min(canvas.width / 12, 18))}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(design.title, canvas.width / 2, canvas.height * 0.72);
                    
                    ctx.font = `${Math.max(10, Math.min(canvas.width / 16, 14))}px Arial`;
                    ctx.fillText(design.subtitle, canvas.width / 2, canvas.height * 0.82);
                } else {
                    // Default style - elegant white area
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(canvas.width * 0.1, canvas.height * 0.6, canvas.width * 0.8, canvas.height * 0.3);
                    
                    ctx.fillStyle = design.bgColor;
                    ctx.font = `bold ${Math.max(12, Math.min(canvas.width / 14, 18))}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(design.title, canvas.width / 2, canvas.height * 0.72);
                    
                    ctx.font = `${Math.max(10, Math.min(canvas.width / 16, 14))}px Arial`;
                    ctx.fillText(design.subtitle, canvas.width / 2, canvas.height * 0.82);
                }
                
                // Add professional border
                ctx.strokeStyle = design.accentColor;
                ctx.lineWidth = 2;
                ctx.strokeRect(2, 2, canvas.width - 4, canvas.height - 4);
                
                return canvas.toDataURL();
            },

            // Helper function to darken colors
            darkenColor: (color, percent) => {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            },
            updateAuthState: () => {
                const authNavItems = document.getElementById('authNavItems');
                const userNavItems = document.getElementById('userNavItems');
                const userName = document.getElementById('userName');
                const adminNavItems = document.querySelectorAll('#adminNavItem, #adminNavItem2');

                if (App.user) {
                    authNavItems.classList.add('d-none');
                    userNavItems.classList.remove('d-none');
                    userName.textContent = App.user.first_name || App.user.username;

                    // Show admin items for staff and admin users
                    if (App.user.user_type === 'staff' || App.user.user_type === 'admin') {
                        adminNavItems.forEach(item => item.classList.remove('d-none'));
                    } else {
                        adminNavItems.forEach(item => item.classList.add('d-none'));
                    }
                } else {
                    authNavItems.classList.remove('d-none');
                    userNavItems.classList.add('d-none');
                }
            },

            showHomePage: () => {
                document.getElementById('mainContent').innerHTML = `
                    <!-- Hero Section -->
                    <section class="hero-section" id="heroSection">
                        <div class="container">
                            <h1>Welcome to Smart Library Platform</h1>
                            <p>Discover, borrow, and explore thousands of books with our intelligent library management system</p>
                            <div>
                                <button class="btn btn-light btn-lg me-3 explore-books-btn">
                                    <i class="fas fa-compass me-2"></i>Explore Books
                                </button>
                                ${!App.user ? `
                                <button class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#registerModal">
                                    <i class="fas fa-user-plus me-2"></i>Join Today
                                </button>
                                ` : `
                                <button class="btn btn-outline-light btn-lg hero-dashboard-btn">
                                    <i class="fas fa-tachometer-alt me-2"></i>My Dashboard
                                </button>
                                `}
                            </div>
                        </div>
                    </section>

                    <!-- Features Section -->
                    <section class="container my-5" id="featuresSection">
                        <h2 class="section-title">Platform Features</h2>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="feature-card text-center">
                                    <i class="fas fa-search feature-icon"></i>
                                    <h4>Smart Search</h4>
                                    <p>Find books by title, author, genre, or keywords with our advanced search functionality.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="feature-card text-center">
                                    <i class="fas fa-mobile-alt feature-icon"></i>
                                    <h4>Digital Reading</h4>
                                    <p>Access eBooks on any device with reading session tracking and analytics.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="feature-card text-center">
                                    <i class="fas fa-star feature-icon"></i>
                                    <h4>Reviews & Ratings</h4>
                                    <p>Share your thoughts and discover great books through community reviews.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="feature-card text-center">
                                    <i class="fas fa-chart-line feature-icon"></i>
                                    <h4>Reading Analytics</h4>
                                    <p>Track your reading habits and get personalized book recommendations.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="feature-card text-center">
                                    <i class="fas fa-bookmark feature-icon"></i>
                                    <h4>Easy Checkout</h4>
                                    <p>Borrow books instantly and manage your reading list with ease.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="feature-card text-center">
                                    <i class="fas fa-users feature-icon"></i>
                                    <h4>Community</h4>
                                    <p>Connect with fellow readers and discover trending books in the community.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Recent Books Section -->
                    <section class="container mb-5">
                        <h2 class="section-title">Featured Books</h2>
                        <div id="featuredBooksContainer" class="row">
                            <div class="col-12 text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </section>
                `;

                // Load featured books
                UI.loadFeaturedBooks();
                
                // Process images after content is loaded
                setTimeout(processBookCoverImages, 200);
            },

            loadFeaturedBooks: async () => {
                try {
                    const data = await Utils.makeRequest('/books?limit=6&sort_by=average_rating&sort_order=DESC');
                    const container = document.getElementById('featuredBooksContainer');
                    
                    if (data.books.length === 0) {
                        container.innerHTML = '<div class="col-12 text-center"><p>No books available at the moment.</p></div>';
                        return;
                    }

                    container.innerHTML = data.books.map(book => `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                                <img src="" class="card-img-top book-cover book-cover-img" alt="${book.title}"
                     data-cover-url="${book.cover_image_url || ''}"
                     loading="lazy">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${book.title}</h5>
                                    <p class="card-text text-muted small">by ${book.authors.join(', ')}</p>
                                    <p class="card-text flex-grow-1">${(book.description || '').substring(0, 100)}...</p>
                                    <div class="mt-auto">
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="rating">
                                                    ${Utils.generateStarRating(book.average_rating)}
                                                    <small class="text-muted">(${book.total_reviews})</small>
                                                </div>
                                                <span class="availability-badge ${book.is_available ? 'bg-success' : 'bg-danger'} text-white">
                                                    ${book.is_available ? `Available (${book.available_copies || 0}/${book.total_copies || 0})` : 'Unavailable'}
                                                </span>
                                            </div>
                                            <button class="btn btn-primary btn-sm mt-2 w-100 view-details-btn" data-book-id="${book.book_id}">
                                                View Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Process images after featured books are loaded
                    setTimeout(processBookCoverImages, 200);
                } catch (error) {
                    document.getElementById('featuredBooksContainer').innerHTML = 
                        '<div class="col-12 text-center"><p class="text-danger">Failed to load featured books.</p></div>';
                }
            },

            showBooksPage: async () => {
                document.getElementById('mainContent').innerHTML = `
                    <div class="container my-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Explore Books</h2>
                            <button class="btn btn-outline-primary" id="advancedSearchToggle">
                                <i class="fas fa-filter me-2"></i>Advanced Search
                            </button>
                        </div>
                        
                        <!-- Basic Search and Filters -->
                        <div class="row mb-4" id="basicSearch">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="bookSearch" placeholder="Search books by title, author, or description...">
                                    <button class="btn btn-outline-secondary" type="button" id="searchButton" title="Search books">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">💡 Tip: Text search will override genre filter for better results</small>
                            </div>
                            <div class="col-md-3">
                                <label for="genreFilter" class="form-label small">Filter by Genre</label>
                                <select class="form-select" id="genreFilter">
                                    <option value="">All Genres</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="sortBy" class="form-label small">Sort Results</label>
                                <select class="form-select" id="sortBy">
                                    <option value="title">Sort by Title</option>
                                    <option value="average_rating">Sort by Rating</option>
                                    <option value="total_borrowed">Sort by Popularity</option>
                                    <option value="publication_date">Sort by Publication Date</option>
                                </select>
                            </div>
                        </div>

                        <!-- Advanced Search Form (Hidden by default) -->
                        <div id="advancedSearchForm" class="card mb-4" style="display: none;">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-search me-2"></i>Advanced Book Search
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="advancedSearch">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="advTitle" class="form-label">Title</label>
                                            <input type="text" class="form-control" id="advTitle" placeholder="Search by book title">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="advAuthor" class="form-label">Author Name</label>
                                            <input type="text" class="form-control" id="advAuthor" placeholder="Search by author name">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="advPublisher" class="form-label">Publisher</label>
                                            <input type="text" class="form-control" id="advPublisher" placeholder="Search by publisher">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="advGenre" class="form-label">Genre</label>
                                            <select class="form-select" id="advGenre">
                                                <option value="">All Genres</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="advISBN" class="form-label">ISBN</label>
                                            <input type="text" class="form-control" id="advISBN" placeholder="Search by ISBN">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label for="advYearFrom" class="form-label">Publication Year From</label>
                                            <input type="number" class="form-control" id="advYearFrom" placeholder="e.g. 2000" min="1800" max="${new Date().getFullYear()}">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="advYearTo" class="form-label">Publication Year To</label>
                                            <input type="number" class="form-control" id="advYearTo" placeholder="e.g. 2024" min="1800" max="${new Date().getFullYear()}">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="advMinRating" class="form-label">Minimum Rating</label>
                                            <select class="form-select" id="advMinRating">
                                                <option value="">Any Rating</option>
                                                <option value="1">1+ Stars</option>
                                                <option value="2">2+ Stars</option>
                                                <option value="3">3+ Stars</option>
                                                <option value="4">4+ Stars</option>
                                                <option value="5">5 Stars</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="advMaxRating" class="form-label">Maximum Rating</label>
                                            <select class="form-select" id="advMaxRating">
                                                <option value="">Any Rating</option>
                                                <option value="1">Up to 1 Star</option>
                                                <option value="2">Up to 2 Stars</option>
                                                <option value="3">Up to 3 Stars</option>
                                                <option value="4">Up to 4 Stars</option>
                                                <option value="5">Up to 5 Stars</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="advAvailableOnly">
                                                <label class="form-check-label" for="advAvailableOnly">
                                                    Show only available books
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="advEbookOnly">
                                                <label class="form-check-label" for="advEbookOnly">
                                                    Show only eBooks
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="advSortBy" class="form-label">Sort By</label>
                                            <select class="form-select" id="advSortBy">
                                                <option value="title">Title</option>
                                                <option value="author">Author</option>
                                                <option value="average_rating">Rating</option>
                                                <option value="total_borrowed">Popularity</option>
                                                <option value="publication_date">Publication Date</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <button type="button" class="btn btn-primary me-2" id="performAdvancedSearch">
                                                <i class="fas fa-search me-2"></i>Search
                                            </button>
                                            <button type="button" class="btn btn-secondary me-2" id="clearAdvancedSearch">
                                                <i class="fas fa-eraser me-2"></i>Clear
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="closeAdvancedSearch">
                                                <i class="fas fa-times me-2"></i>Close
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Search Results Info -->
                        <div id="searchResultsInfo" class="mb-3" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="searchResultsText"></span>
                                <button type="button" class="btn btn-sm btn-outline-info ms-2" id="clearAllFilters">
                                    Clear Filters
                                </button>
                            </div>
                        </div>

                        <!-- Books Grid -->
                        <div id="booksContainer" class="row">
                            <div class="col-12 text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <nav id="booksPagination" class="mt-4"></nav>
                    </div>
                `;

                UI.loadBooks();
                UI.loadGenresForAdvancedSearch();
                
                // Process images after content is loaded
                setTimeout(processBookCoverImages, 200);
            },

            loadBooks: async (page = 1, search = '', genre = '', sortBy = 'title') => {
                try {
                    const params = new URLSearchParams({
                        page,
                        limit: 12,
                        sort_by: sortBy,
                        sort_order: 'ASC'
                    });

                    if (search) params.append('search', search);
                    if (genre) params.append('genre', genre);

                    const data = await Utils.makeRequest(`/books?${params}`);
                    const container = document.getElementById('booksContainer');
                    
                    if (data.books.length === 0) {
                        container.innerHTML = '<div class="col-12 text-center"><p>No books found.</p></div>';
                        return;
                    }

                    container.innerHTML = data.books.map(book => `
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <img src="" class="card-img-top book-cover book-cover-img" alt="${book.title}"
                                     data-cover-url="${book.cover_image_url || ''}"
                                     style="height: 250px; object-fit: cover;" loading="lazy">
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title">${book.title}</h6>
                                    <p class="card-text text-muted small">by ${book.authors.join(', ')}</p>
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="rating small">
                                                ${Utils.generateStarRating(book.average_rating)}
                                            </div>
                                            <span class="availability-badge ${book.is_available ? 'bg-success' : 'bg-danger'} text-white">
                                                ${book.is_available ? `Available (${book.available_copies || 0}/${book.total_copies || 0})` : 'Unavailable'}
                                            </span>
                                        </div>
                                        <button class="btn btn-primary btn-sm w-100 view-details-btn" data-book-id="${book.book_id}">
                                            View Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // Update pagination
                    UI.updatePagination('booksPagination', data.pagination, (newPage) => {
                        const search = document.getElementById('bookSearch')?.value || '';
                        const genre = document.getElementById('genreFilter')?.value || '';
                        const sortBy = document.getElementById('sortBy')?.value || 'title';
                        UI.loadBooks(newPage, search, genre, sortBy);
                    });

                    // Populate genre filter if empty
                    const genreFilter = document.getElementById('genreFilter');
                    if (genreFilter.children.length === 1 && data.filters.available_genres) {
                        data.filters.available_genres.forEach(genre => {
                            const option = document.createElement('option');
                            option.value = genre;
                            option.textContent = genre;
                            genreFilter.appendChild(option);
                        });
                    }
                    
                    // Process images after books are loaded
                    setTimeout(processBookCoverImages, 200);
                } catch (error) {
                    document.getElementById('booksContainer').innerHTML = 
                        '<div class="col-12 text-center"><p class="text-danger">Failed to load books.</p></div>';
                }
            },

            updatePagination: (containerId, pagination, onPageChange) => {
                const container = document.getElementById(containerId);
                if (!container || !pagination) return;

                const { current_page, total_pages, has_prev, has_next } = pagination;
                
                if (total_pages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                let paginationHTML = '<ul class="pagination justify-content-center">';
                
                // Previous button
                paginationHTML += `
                    <li class="page-item ${!has_prev ? 'disabled' : ''}">
                        <a class="page-link pagination-btn" href="#" data-page="${current_page - 1}" data-enabled="${has_prev}">
                            Previous
                        </a>
                    </li>
                `;

                // Page numbers
                const startPage = Math.max(1, current_page - 2);
                const endPage = Math.min(total_pages, current_page + 2);

                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <li class="page-item ${i === current_page ? 'active' : ''}">
                            <a class="page-link pagination-btn" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                }

                // Next button
                paginationHTML += `
                    <li class="page-item ${!has_next ? 'disabled' : ''}">
                        <a class="page-link pagination-btn" href="#" data-page="${current_page + 1}" data-enabled="${has_next}">
                            Next
                        </a>
                    </li>
                `;

                paginationHTML += '</ul>';
                container.innerHTML = paginationHTML;
                
                // Store the callback for pagination events
                container.dataset.pageCallback = onPageChange.toString();
            },

            searchBooks: () => {
                const search = document.getElementById('bookSearch').value.trim();
                const genre = document.getElementById('genreFilter').value;
                const sortBy = document.getElementById('sortBy').value;
                
                // If user is typing in search box, prioritize the search over genre filter
                // Clear genre filter when user is actively searching with text
                if (search && genre) {
                    // Show warning and clear genre filter to get better results
                    Utils.showAlert('Search term found! Genre filter cleared to show all matching books.', 'info');
                    document.getElementById('genreFilter').value = '';
                    UI.loadBooks(1, search, '', sortBy);
                } else {
                    UI.loadBooks(1, search, genre, sortBy);
                }
            },

            handleGenreChange: () => {
                const search = document.getElementById('bookSearch').value.trim();
                const genre = document.getElementById('genreFilter').value;
                const sortBy = document.getElementById('sortBy').value;
                
                // If there's text in search box, warn user about combining filters
                if (search && genre) {
                    const proceed = confirm(`You have "${search}" in the search box and selected "${genre}" genre. This might limit your results. Do you want to:\n\n• Click OK to search with both filters\n• Click Cancel to clear the text search and filter by genre only`);
                    
                    if (!proceed) {
                        document.getElementById('bookSearch').value = '';
                        UI.loadBooks(1, '', genre, sortBy);
                    } else {
                        UI.loadBooks(1, search, genre, sortBy);
                    }
                } else {
                    UI.loadBooks(1, search, genre, sortBy);
                }
            },

            handleSortChange: () => {
                const search = document.getElementById('bookSearch').value.trim();
                const genre = document.getElementById('genreFilter').value;
                const sortBy = document.getElementById('sortBy').value;
                UI.loadBooks(1, search, genre, sortBy);
            },

            showAnalyticsPage: async () => {
                // Check if user is staff or admin
                if (!App.user || (App.user.user_type !== 'staff' && App.user.user_type !== 'admin')) {
                    document.getElementById('mainContent').innerHTML = `
                        <div class="container my-4">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Access denied. Analytics dashboard is only available for staff and admin members.
                            </div>
                        </div>
                    `;
                    return;
                }

                document.getElementById('mainContent').innerHTML = `
                    <div class="container my-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fas fa-chart-bar me-2"></i>Reading Analytics Dashboard</h2>
                            <button class="btn btn-outline-primary" id="refreshAnalytics">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Data
                            </button>
                        </div>

                        <!-- Analytics Tabs -->
                        <ul class="nav nav-tabs mb-4" id="analyticsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                    <i class="fas fa-tachometer-alt me-2"></i>Overview
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="session-time-tab" data-bs-toggle="tab" data-bs-target="#session-time" type="button" role="tab">
                                    <i class="fas fa-clock me-2"></i>Session Time
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="highlights-tab" data-bs-toggle="tab" data-bs-target="#highlights" type="button" role="tab">
                                    <i class="fas fa-highlighter me-2"></i>Highlights
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="top-books-tab" data-bs-toggle="tab" data-bs-target="#top-books" type="button" role="tab">
                                    <i class="fas fa-book me-2"></i>Top Books
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="analyticsTabContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                                <h5 class="card-title" id="totalUsersAnalytics">-</h5>
                                                <p class="card-text">Active Readers</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <i class="fas fa-book-open fa-2x text-success mb-2"></i>
                                                <h5 class="card-title" id="totalSessionsAnalytics">-</h5>
                                                <p class="card-text">Reading Sessions</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <i class="fas fa-highlighter fa-2x text-warning mb-2"></i>
                                                <h5 class="card-title" id="totalHighlightsAnalytics">-</h5>
                                                <p class="card-text">Total Highlights</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                                                <h5 class="card-title" id="totalReadingTimeAnalytics">-</h5>
                                                <p class="card-text">Hours Read</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>Device Usage</h5>
                                            </div>
                                            <div class="card-body">
                                                <div id="deviceUsageChart">
                                                    <div class="text-center">
                                                        <div class="spinner-border" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="fas fa-star me-2"></i>Recent Highlights</h5>
                                            </div>
                                            <div class="card-body">
                                                <div id="recentHighlights">
                                                    <div class="text-center">
                                                        <div class="spinner-border" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Session Time Tab -->
                            <div class="tab-pane fade" id="session-time" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Average Session Time Per User</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sessionTimeData">
                                            <div class="text-center">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Highlights Tab -->
                            <div class="tab-pane fade" id="highlights" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-highlighter me-2"></i>Most Highlighted Books</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="highlightsData">
                                            <div class="text-center">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Top Books Tab -->
                            <div class="tab-pane fade" id="top-books" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-book me-2"></i>Top 10 Books by Total Reading Time</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="topBooksData">
                                            <div class="text-center">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Load analytics data
                await UI.loadAnalyticsData();
            },

            loadAnalyticsData: async () => {
                try {
                    // Load overview data
                    const [dashboardData, userEngagement, highlightsData, bookPopularity] = await Promise.all([
                        Utils.makeRequest('/analytics/dashboard'),
                        Utils.makeRequest('/analytics/user-engagement?limit=10'),
                        Utils.makeRequest('/analytics/highlights?limit=10'),
                        Utils.makeRequest('/analytics/book-popularity?limit=10&metric=reading_time')
                    ]);

                    // Update overview cards
                    document.getElementById('totalUsersAnalytics').textContent = dashboardData.dashboard.summary.unique_users_today || 0;
                    document.getElementById('totalSessionsAnalytics').textContent = dashboardData.dashboard.summary.total_sessions || 0;
                    document.getElementById('totalHighlightsAnalytics').textContent = highlightsData.popular_highlights.length || 0;
                    document.getElementById('totalReadingTimeAnalytics').textContent = 
                        Math.round((dashboardData.dashboard.summary.total_reading_time_today || 0) / 60 * 10) / 10;

                    // Update device usage chart
                    const deviceUsage = dashboardData.dashboard.device_distribution;
                    const deviceUsageHtml = Object.entries(deviceUsage).map(([device, count]) => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span><i class="fas fa-${device === 'mobile' ? 'mobile-alt' : device === 'tablet' ? 'tablet-alt' : device === 'desktop' ? 'desktop' : 'book'} me-2"></i>${device.charAt(0).toUpperCase() + device.slice(1)}</span>
                            <span class="badge bg-primary">${count} sessions</span>
                        </div>
                    `).join('');
                    document.getElementById('deviceUsageChart').innerHTML = deviceUsageHtml || '<p class="text-muted">No device data available</p>';

                    // Update recent highlights
                    const recentHighlights = dashboardData.dashboard.recent_highlights || [];
                    const highlightsHtml = recentHighlights.map(highlight => `
                        <div class="border-bottom pb-2 mb-2">
                            <small class="text-muted">Book ${highlight.book_id} - Page ${highlight.highlight_page}</small>
                            <p class="mb-1">"${highlight.highlight_text.substring(0, 100)}${highlight.highlight_text.length > 100 ? '...' : ''}"</p>
                            <small class="text-muted">
                                <i class="fas fa-${highlight.highlight_color === 'yellow' ? 'highlighter' : 'paint-brush'} me-1"></i>
                                ${highlight.highlight_color} highlight
                            </small>
                        </div>
                    `).join('');
                    document.getElementById('recentHighlights').innerHTML = highlightsHtml || '<p class="text-muted">No recent highlights</p>';

                    // Update session time data
                    const sessionTimeHtml = userEngagement.user_engagement.map(user => `
                        <div class="row border-bottom py-2">
                            <div class="col-md-3">
                                <strong>User ${user.user_id}</strong>
                            </div>
                            <div class="col-md-3">
                                <span class="badge bg-info">${user.average_session_duration_minutes.toFixed(1)} min avg</span>
                            </div>
                            <div class="col-md-3">
                                <span class="badge bg-success">${user.total_sessions} sessions</span>
                            </div>
                            <div class="col-md-3">
                                <span class="badge bg-warning">${user.hours_read} hours total</span>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('sessionTimeData').innerHTML = sessionTimeHtml || '<p class="text-muted">No session data available</p>';

                    // Update highlights data
                    const highlightsTableHtml = highlightsData.popular_highlights.map((highlight, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>Book ${highlight.book_id}</td>
                            <td>"${highlight.highlight_text.substring(0, 80)}${highlight.highlight_text.length > 80 ? '...' : ''}"</td>
                            <td><span class="badge bg-primary">${highlight.highlight_count}</span></td>
                            <td><span class="badge bg-secondary">${highlight.unique_users_count} users</span></td>
                        </tr>
                    `).join('');
                    document.getElementById('highlightsData').innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Book ID</th>
                                        <th>Highlight Text</th>
                                        <th>Count</th>
                                        <th>Users</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${highlightsTableHtml}
                                </tbody>
                            </table>
                        </div>
                    `;

                    // Update top books data
                    const topBooksHtml = bookPopularity.book_popularity.map((book, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>Book ${book.book_id}</td>
                            <td><span class="badge bg-success">${book.hours_read} hours</span></td>
                            <td><span class="badge bg-info">${book.total_sessions} sessions</span></td>
                            <td><span class="badge bg-warning">${book.unique_readers_count} readers</span></td>
                            <td><span class="badge bg-primary">${book.total_pages_read} pages</span></td>
                        </tr>
                    `).join('');
                    document.getElementById('topBooksData').innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Book ID</th>
                                        <th>Reading Time</th>
                                        <th>Sessions</th>
                                        <th>Readers</th>
                                        <th>Pages Read</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topBooksHtml}
                                </tbody>
                            </table>
                        </div>
                    `;

                } catch (error) {
                    console.error('Error loading analytics data:', error);
                    Utils.showAlert('Failed to load analytics data', 'danger');
                }
            },

            showBookDetails: async (bookId) => {
                document.getElementById('mainContent').innerHTML = `
                    <div class="container my-4">
                        <div class="row">
                            <div class="col-12">
                                <button class="btn btn-outline-secondary mb-3" id="backToBooksBtn">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Books
                                </button>
                            </div>
                        </div>
                        <div id="bookDetailsContainer">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                try {
                    // Load user data if user is logged in
                    if (App.user) {
                        await UI.loadUserData();
                    }
                    
                    const data = await Utils.makeRequest(`/books/${bookId}`);
                    const book = data.book;
                    const reviews = data.reviews || [];
                    const similarBooks = data.similar_books || [];
                    const seriesBooks = data.series_books || [];
                    
                    document.getElementById('bookDetailsContainer').innerHTML = `
                        <div class="row">
                            <!-- Book Cover and Actions -->
                            <div class="col-md-4">
                                <div class="card">
                                    <img src="" class="card-img-top book-cover book-cover-img" alt="${book.title}"
                                         data-cover-url="${book.cover_image_url || ''}"
                                         loading="lazy">
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                    ${App.user && book.is_available ? `
                                                <button class="btn btn-success borrow-btn" data-book-id="${book.book_id}" data-book-title="${book.title}">
                                                    <i class="fas fa-book me-2"></i>Borrow Book
                                                </button>
                                            ` : !book.is_available ? `
                                                <button class="btn btn-secondary" disabled>
                                                    <i class="fas fa-times me-2"></i>Unavailable
                                                </button>
                                            ` : `
                                                <button class="btn btn-outline-primary" disabled>
                                                    <i class="fas fa-sign-in-alt me-2"></i>Login to Borrow
                                                </button>
                                            `}
                                            
                                            ${App.user && UI.hasUserBorrowedBook(book.book_id) ? `
                                                <button class="btn btn-warning return-btn" data-book-id="${book.book_id}" data-book-title="${book.title}">
                                                    <i class="fas fa-undo me-2"></i>Return Book
                                        </button>
                                    ` : ''}
                                            
                                            ${App.user && UI.hasUserBorrowedBook(book.book_id) && !UI.hasUserReviewedBook(book.book_id) ? `
                                                <button class="btn btn-info review-btn" data-book-id="${book.book_id}" data-book-title="${book.title}">
                                                    <i class="fas fa-star me-2"></i>Write Review
                                                </button>
                                            ` : ''}
                                    </div>
                                </div>
                            </div>
                                
                                <!-- Quick Info Card -->
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Quick Info</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-2">
                                            <div class="col-12">
                                                <strong>Availability:</strong> 
                                                <span class="badge ${book.is_available ? 'bg-success' : 'bg-danger'}">
                                                    ${book.is_available ? `Available (${book.available_copies}/${book.total_copies})` : 'Unavailable'}
                                                </span>
                                            </div>
                                            <div class="col-12">
                                                <strong>Rating:</strong> 
                                                ${book.average_rating > 0 ? `
                                                    <span class="text-warning">
                                                        ${'★'.repeat(Math.round(book.average_rating))}${'☆'.repeat(5 - Math.round(book.average_rating))}
                                                    </span>
                                                    <small class="text-muted">(${book.total_reviews} reviews)</small>
                                                ` : '<span class="text-muted">No ratings yet</span>'}
                                            </div>
                                            ${book.metadata && book.metadata.content && book.metadata.content.age_rating ? `
                                                <div class="col-12">
                                                    <strong>Age Rating:</strong> <span class="badge bg-info">${book.metadata.content.age_rating}</span>
                                                </div>
                                            ` : ''}
                                            ${book.metadata && book.metadata.physical && book.metadata.physical.format ? `
                                                <div class="col-12">
                                                    <strong>Format:</strong> <span class="text-capitalize">${book.metadata.physical.format}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Book Information -->
                            <div class="col-md-8">
                                <div class="mb-4">
                                    <h1 class="display-6">${book.title}</h1>
                                    ${book.metadata && book.metadata.translation && book.metadata.translation.original_title ? `
                                        <p class="text-muted fs-5">Original Title: <em>${book.metadata.translation.original_title}</em></p>
                                    ` : ''}
                                    <p class="fs-5 text-primary">by ${book.authors.map(author => author.name).join(', ')}</p>
                                    
                                    ${book.metadata && book.metadata.series ? `
                                        <div class="alert alert-info">
                                            <i class="fas fa-bookmark me-2"></i>
                                            <strong>Part of Series:</strong> ${book.metadata.series.series_name}
                                            ${book.metadata.series.series_order ? ` (Book ${book.metadata.series.series_order})` : ''}
                                            <small class="text-muted">- ${book.metadata.series.total_books_in_series} books in series</small>
                                </div>
                                    ` : ''}
                                    
                                    ${book.sequel || book.prequel ? `
                                        <div class="alert alert-secondary">
                                            <i class="fas fa-link me-2"></i>
                                            <strong>Series Order:</strong>
                                            ${book.prequel ? `<a href="#" class="view-details-btn text-decoration-none" data-book-id="${book.prequel.book_id}">← ${book.prequel.title}</a> | ` : ''}
                                            <span class="fw-bold">${book.title}</span>
                                            ${book.sequel ? ` | <a href="#" class="view-details-btn text-decoration-none" data-book-id="${book.sequel.book_id}">${book.sequel.title} →</a>` : ''}
                                    </div>
                                    ` : ''}
                                    </div>
                                
                                <!-- Book Description -->
                                ${book.description ? `
                                    <div class="mb-4">
                                        <h4><i class="fas fa-align-left me-2"></i>Description</h4>
                                        <div class="card">
                                            <div class="card-body">
                                                <p class="card-text">${book.description}</p>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Comprehensive Book Details -->
                                <div class="mb-4">
                                    <h4><i class="fas fa-info-circle me-2"></i>Book Details</h4>
                                    <div class="row">
                                        <!-- Publication Information -->
                                    <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>Publication</h6>
                                    </div>
                                                <div class="card-body">
                                                    ${book.publisher ? `<p><strong>Publisher:</strong> ${book.publisher}</p>` : ''}
                                                    ${book.publication_date ? `<p><strong>Publication Date:</strong> ${Utils.formatDate(book.publication_date)}</p>` : ''}
                                                    ${book.first_published_date && book.first_published_date !== book.publication_date ? `<p><strong>First Published:</strong> ${Utils.formatDate(book.first_published_date)}</p>` : ''}
                                                    ${book.copyright_date ? `<p><strong>Copyright:</strong> ${Utils.formatDate(book.copyright_date)}</p>` : ''}
                                                    ${book.country_of_origin ? `<p><strong>Country:</strong> ${book.country_of_origin}</p>` : ''}
                                                    ${book.edition ? `<p><strong>Edition:</strong> ${book.edition}</p>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Physical Details -->
                                    <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-book-open me-2"></i>Physical Details</h6>
                                    </div>
                                                <div class="card-body">
                                                    ${book.pages ? `<p><strong>Pages:</strong> ${book.pages}</p>` : ''}
                                                    ${book.format_type ? `<p><strong>Format:</strong> <span class="text-capitalize">${book.format_type}</span></p>` : ''}
                                                    ${book.language ? `<p><strong>Language:</strong> ${book.language}</p>` : ''}
                                                    ${book.dimensions ? `<p><strong>Dimensions:</strong> ${book.dimensions}</p>` : ''}
                                                    ${book.genre ? `<p><strong>Genre:</strong> <span class="badge bg-primary">${book.genre}</span></p>` : ''}
                                                    ${book.is_ebook ? `<p><span class="badge bg-success"><i class="fas fa-tablet-alt me-1"></i>E-book Available</span></p>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Identifiers Row -->
                                    <div class="row mt-3">
                                    <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-barcode me-2"></i>Identifiers</h6>
                                    </div>
                                                <div class="card-body">
                                                    ${book.isbn13 ? `<p><strong>ISBN-13:</strong> <code>${book.isbn13}</code></p>` : ''}
                                                    ${book.isbn10 ? `<p><strong>ISBN-10:</strong> <code>${book.isbn10}</code></p>` : ''}
                                                    ${book.isbn && !book.isbn13 && !book.isbn10 ? `<p><strong>ISBN:</strong> <code>${book.isbn}</code></p>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Awards and Recognition -->
                                        ${book.awards || book.content_warnings ? `
                                    <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0"><i class="fas fa-award me-2"></i>Additional Info</h6>
                                    </div>
                                                    <div class="card-body">
                                                        ${book.awards ? `<p><strong>Awards:</strong> ${book.awards}</p>` : ''}
                                                        ${book.content_warnings ? `
                                                            <p><strong>Content Warnings:</strong></p>
                                                            <div class="alert alert-warning py-2">
                                                                <small><i class="fas fa-exclamation-triangle me-1"></i>${book.content_warnings}</small>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        ` : ''}
                                </div>

                                    <!-- Translation Information -->
                                    ${book.translated_from ? `
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0"><i class="fas fa-language me-2"></i>Translation Information</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        ${book.original_title ? `<p><strong>Original Title:</strong> <em>${book.original_title}</em></p>` : ''}
                                                        ${book.translated_from ? `<p><strong>Translated from:</strong> ${book.translated_from}</p>` : ''}
                                                        ${book.translator ? `<p><strong>Translator:</strong> ${book.translator}</p>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- Author Information -->
                                ${book.authors.length > 0 ? `
                                    <div class="mb-4">
                                        <h4><i class="fas fa-user-edit me-2"></i>Author${book.authors.length > 1 ? 's' : ''}</h4>
                                        <div class="row">
                                        ${book.authors.map(author => `
                                                <div class="col-md-6 mb-3">
                                                    <div class="card h-100">
                                                        <div class="card-body">
                                                            <h6 class="card-title">${author.name}</h6>
                                                            ${author.nationality ? `<p class="text-muted small"><i class="fas fa-globe me-1"></i>${author.nationality}</p>` : ''}
                                                            ${author.biography ? `<p class="card-text small">${author.biography}</p>` : ''}
                                                        </div>
                                                    </div>
                                            </div>
                                        `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Series Books Section -->
                        ${seriesBooks.length > 1 ? `
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4><i class="fas fa-bookmark me-2"></i>Books in ${book.series_name} Series</h4>
                                    <div class="row">
                                        ${seriesBooks.map(seriesBook => `
                                            <div class="col-md-2 col-sm-4 col-6 mb-3">
                                                <div class="card h-100 ${seriesBook.is_current ? 'border-primary' : ''}">
                                                    <img src="" class="card-img-top" alt="${seriesBook.title}" style="height: 200px; object-fit: cover;" data-cover-url="${seriesBook.cover_image_url || ''}">
                                                    <div class="card-body p-2">
                                                        <h6 class="card-title small">${seriesBook.title}</h6>
                                                        ${seriesBook.series_order ? `<small class="text-muted">Book ${seriesBook.series_order}</small><br>` : ''}
                                                        <p class="card-text small text-muted">${seriesBook.authors.join(', ')}</p>
                                                        ${seriesBook.is_current ? `
                                                            <span class="badge bg-primary">Current Book</span>
                                                        ` : `
                                                            <button class="btn btn-outline-primary btn-sm view-details-btn" data-book-id="${seriesBook.book_id}">
                                                                View Details
                                                            </button>
                                                        `}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Reviews Section -->
                        <div class="row mt-5">
                            <div class="col-12">
                                <h4><i class="fas fa-star me-2"></i>Reviews</h4>
                                ${App.user ? `
                                    <div class="mb-3">
                                        <button class="btn btn-outline-primary add-review-btn" data-book-id="${book.book_id}">
                                            <i class="fas fa-plus me-2"></i>Add Review
                                        </button>
                                    </div>
                                ` : ''}
                                <div id="reviewsContainer">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading reviews...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Similar Books Section -->
                        ${similarBooks.length > 0 ? `
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4><i class="fas fa-books me-2"></i>Similar Books</h4>
                                    <div class="row">
                                        ${similarBooks.map(similar => `
                                            <div class="col-md-2 col-sm-4 col-6 mb-3">
                                                <div class="card h-100">
                                                    <img src="" class="card-img-top" alt="${similar.title}" style="height: 200px; object-fit: cover;" data-cover-url="${similar.cover_image_url || ''}">
                                                    <div class="card-body p-2">
                                                        <h6 class="card-title small">${similar.title}</h6>
                                                        <p class="card-text small text-muted">${similar.authors.join(', ')}</p>
                                                        <button class="btn btn-outline-primary btn-sm view-details-btn" data-book-id="${similar.book_id}">
                                                            View Details
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    `;

                    // Load reviews
                    UI.loadBookReviews(bookId);
                } catch (error) {
                    document.getElementById('bookDetailsContainer').innerHTML = 
                        '<div class="alert alert-danger">Failed to load book details.</div>';
                }
            },

            loadBookReviews: async (bookId) => {
                try {
                    const data = await Utils.makeRequest(`/reviews/book/${bookId}`);
                    const container = document.getElementById('reviewsContainer');
                    
                    if (data.reviews.length === 0) {
                        container.innerHTML = '<p class="text-muted">No reviews yet. Be the first to review this book!</p>';
                        return;
                    }

                    container.innerHTML = data.reviews.map(review => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>${review.reviewer_name}</strong>
                                        <div class="rating">
                                            ${Utils.generateStarRating(review.rating)}
                                        </div>
                                    </div>
                                    <small class="text-muted">${Utils.formatDate(review.review_date)}</small>
                                </div>
                                ${review.comment ? `<p class="mt-2 mb-0">${review.comment}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    document.getElementById('reviewsContainer').innerHTML = 
                        '<div class="alert alert-danger">Failed to load reviews.</div>';
                }
            },

            showDashboard: async () => {
                if (!App.user) {
                    Utils.showAlert('Please log in to view your dashboard.', 'warning');
                    return;
                }

                document.getElementById('mainContent').innerHTML = `
                    <div class="container my-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>My Dashboard</h2>
                            <button class="btn btn-outline-primary refresh-dashboard-btn" id="refreshDashboardBtn">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                        </div>
                        <div id="dashboardContainer">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading dashboard...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                try {
                    const data = await Utils.makeRequest(`/users/${App.user.user_id}/dashboard`);
                    const dashboard = data.dashboard;
                    
                    document.getElementById('dashboardContainer').innerHTML = `
                        <!-- User Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-primary">${dashboard.user_statistics.active_checkouts}</h3>
                                        <p class="card-text">Active Checkouts</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-success">${dashboard.user_statistics.unique_books_read}</h3>
                                        <p class="card-text">Books Read</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-warning">${dashboard.user_statistics.total_reviews}</h3>
                                        <p class="card-text">Reviews Written</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-info">${dashboard.yearly_progress.books_read_this_year}</h3>
                                        <p class="card-text">Books This Year</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Active Checkouts -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-bookmark me-2"></i>Active Checkouts</h5>
                                    </div>
                                    <div class="card-body">
                                        ${dashboard.active_checkouts.length === 0 ? 
                                            '<p class="text-muted">No active checkouts.</p>' :
                                            dashboard.active_checkouts.map(checkout => `
                                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                                    <div>
                                                        <strong>${checkout.title}</strong>
                                                        <br><small class="text-muted">Due: ${Utils.formatDate(checkout.due_date)}</small>
                                                    </div>
                                                    <span class="badge ${checkout.is_overdue ? 'bg-danger' : checkout.days_until_due <= 2 ? 'bg-warning' : 'bg-success'}">
                                                        ${checkout.is_overdue ? 'Overdue' : `${checkout.days_until_due} days left`}
                                                    </span>
                                                </div>
                                            `).join('')
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-star me-2"></i>Recent Reviews</h5>
                                    </div>
                                    <div class="card-body">
                                        ${dashboard.recent_reviews.length === 0 ? 
                                            '<p class="text-muted">No reviews yet.</p>' :
                                            dashboard.recent_reviews.map(review => `
                                                <div class="mb-2 p-2 border rounded">
                                                    <strong>${review.title}</strong>
                                                    <div class="rating">
                                                        ${Utils.generateStarRating(review.rating)}
                                                    </div>
                                                    <small class="text-muted">${Utils.formatDate(review.review_date)}</small>
                                                </div>
                                            `).join('')
                                        }
                                     </div>
                                 </div>
                             </div>
                         </div>

                         <!-- My Checkouts Section -->
                         <div class="row mt-4">
                             <div class="col-12">
                                 <div class="card">
                                     <div class="card-header d-flex justify-content-between align-items-center">
                                         <h5><i class="fas fa-bookmark me-2"></i>My Checkouts</h5>
                                         <button class="btn btn-outline-primary btn-sm view-all-checkouts-btn">
                                             <i class="fas fa-list me-1"></i>View All
                                         </button>
                                     </div>
                                     <div class="card-body">
                                         ${dashboard.active_checkouts.length === 0 ? 
                                             '<p class="text-muted">No active checkouts.</p>' :
                                             dashboard.active_checkouts.map(checkout => `
                                                 <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                                     <div class="flex-grow-1">
                                                         <h6 class="mb-1">${checkout.title}</h6>
                                                         <small class="text-muted">Due: ${Utils.formatDate(checkout.due_date)}</small>
                                                     </div>
                                                     <div class="text-end">
                                                         <span class="badge ${checkout.is_overdue ? 'bg-danger' : checkout.days_until_due <= 2 ? 'bg-warning' : 'bg-success'} mb-2">
                                                             ${checkout.is_overdue ? 'Overdue' : `${checkout.days_until_due} days left`}
                                                         </span>
                                                         <br>
                                                         <button class="btn btn-warning btn-sm return-btn" 
                                                                 data-book-id="${checkout.book_id}" 
                                                                 data-book-title="${checkout.title}">
                                                             <i class="fas fa-undo me-1"></i>Return
                                                         </button>
                                                     </div>
                                                 </div>
                                             `).join('')
                                         }
                                     </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    document.getElementById('dashboardContainer').innerHTML = 
                        '<div class="alert alert-danger">Failed to load dashboard.</div>';
                }
            }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Modal focus management for accessibility
            const modals = ['loginModal', 'registerModal', 'borrowModal', 'returnModal', 'reviewModal'];
            
            modals.forEach(modalId => {
                const modalElement = document.getElementById(modalId);
                if (modalElement) {
                    modalElement.addEventListener('show.bs.modal', function () {
                        // Ensure aria-hidden is removed when showing
                        this.removeAttribute('aria-hidden');
                    });
                    
                    modalElement.addEventListener('shown.bs.modal', function () {
                        // Focus on the first input field when modal opens
                        const firstInput = this.querySelector('input:not([type="hidden"]), textarea, select');
                        if (firstInput) {
                            firstInput.focus();
                        }
                    });
                    
                    modalElement.addEventListener('hide.bs.modal', function () {
                        // Remove focus from modal elements before hiding
                        const focusedElement = this.querySelector(':focus');
                        if (focusedElement) {
                            focusedElement.blur();
                        }
                    });
                    
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        // Ensure aria-hidden is properly set when hidden
                        this.setAttribute('aria-hidden', 'true');
                        // Remove any lingering focus issues
                        if (document.activeElement && document.activeElement !== document.body) {
                            document.activeElement.blur();
                        }
                    });
                }
            });
            
            // Check authentication status
            Auth.checkAuth();

            // Initialize enhanced image loading system
            initializeImageLoading();

            // Navigation event listeners
            document.getElementById('navBrand').addEventListener('click', (e) => {
                e.preventDefault();
                UI.showHomePage();
            });

            document.getElementById('navBooks').addEventListener('click', (e) => {
                e.preventDefault();
                App.currentView = 'books';
                UI.showBooksPage();
            });

            document.getElementById('navAnalytics').addEventListener('click', (e) => {
                e.preventDefault();
                App.currentView = 'analytics';
                UI.showAnalyticsPage();
            });

            document.getElementById('navDashboard')?.addEventListener('click', (e) => {
                e.preventDefault();
                App.currentView = 'dashboard';
                UI.showDashboard();
            });

            document.getElementById('navLogout')?.addEventListener('click', (e) => {
                e.preventDefault();
                Auth.logout();
            });

            // Login form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                await Auth.login(username, password);
            });

            // Register form
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const userData = {
                    username: document.getElementById('registerUsername').value,
                    email: document.getElementById('registerEmail').value,
                    password: document.getElementById('registerPassword').value,
                    firstName: document.getElementById('registerFirstName').value,
                    lastName: document.getElementById('registerLastName').value,
                    phone: document.getElementById('registerPhone').value
                };
                await Auth.register(userData);
            });

            // Explore button
            document.getElementById('exploreButton')?.addEventListener('click', () => {
                App.currentView = 'books';
                UI.showBooksPage();
            });

            // Search functionality and book action event listeners
            document.addEventListener('click', async (e) => {
                if (e.target.id === 'searchButton' || e.target.closest('#searchButton')) {
                    UI.searchBooks();
                } else if (e.target.id === 'advancedSearchToggle' || e.target.closest('#advancedSearchToggle')) {
                    UI.toggleAdvancedSearch();
                } else if (e.target.id === 'performAdvancedSearch' || e.target.closest('#performAdvancedSearch')) {
                    UI.performAdvancedSearch();
                } else if (e.target.id === 'clearAdvancedSearch' || e.target.closest('#clearAdvancedSearch')) {
                    UI.clearAdvancedSearch();
                } else if (e.target.id === 'closeAdvancedSearch' || e.target.closest('#closeAdvancedSearch')) {
                    UI.toggleAdvancedSearch();
                } else if (e.target.id === 'clearAllFilters' || e.target.closest('#clearAllFilters')) {
                    UI.clearAllFilters();
                } else if (e.target.classList.contains('borrow-btn') || e.target.closest('.borrow-btn')) {
                    const btn = e.target.closest('.borrow-btn') || e.target;
                    const bookId = btn.dataset.bookId;
                    const bookTitle = btn.dataset.bookTitle;
                    UI.showBorrowModal(bookId, bookTitle);
                } else if (e.target.classList.contains('return-btn') || e.target.closest('.return-btn')) {
                    const btn = e.target.closest('.return-btn') || e.target;
                    const bookId = btn.dataset.bookId;
                    const bookTitle = btn.dataset.bookTitle;
                    
                    // Ensure we have fresh checkout data before opening the modal
                    try { 
                        if (!App.userCheckouts || !Array.isArray(App.userCheckouts)) { 
                            await UI.loadUserData(); 
                        } 
                    } catch (error) { 
                        console.error('❌ Error loading user data:', error);
                    }
                    
                    UI.showReturnModal(bookId, bookTitle);
                } else if (e.target.classList.contains('review-btn') || e.target.closest('.review-btn')) {
                    const btn = e.target.closest('.review-btn') || e.target;
                    const bookId = btn.dataset.bookId;
                    const bookTitle = btn.dataset.bookTitle;
                    UI.showReviewModal(bookId, bookTitle);
                } else if (e.target.id === 'backToBooksBtn') {
                    App.currentView = 'books';
                    UI.showBooksPage();
                } else if (e.target.classList.contains('view-details-btn') || e.target.closest('.view-details-btn')) {
                    const btn = e.target.closest('.view-details-btn') || e.target;
                    const bookId = btn.dataset.bookId;
                    UI.showBookDetails(bookId);
                } else if (e.target.classList.contains('explore-books-btn')) {
                    App.currentView = 'books';
                    UI.showBooksPage();
                } else if (e.target.classList.contains('hero-dashboard-btn')) {
                    App.currentView = 'dashboard';
                    UI.showDashboard();
                } else if (e.target.id === 'navAdmin' || e.target.closest('#navAdmin')) {
                    e.preventDefault();
                    App.currentView = 'admin';
                    await UI.showAdminPanel();
                } else if (e.target.id === 'navCheckouts' || e.target.closest('#navCheckouts')) {
                    e.preventDefault();
                    App.currentView = 'checkouts';
                    UI.showAllCheckouts();
                } else if (e.target.id === 'navReviews' || e.target.closest('#navReviews')) {
                    e.preventDefault();
                    App.currentView = 'reviews';
                    UI.showMyReviews();
                } else if (e.target.classList.contains('pagination-btn')) {
                    e.preventDefault();
                    const enabled = e.target.dataset.enabled;
                    if (enabled === 'false') return;
                    
                    const page = parseInt(e.target.dataset.page);
                    const container = e.target.closest('[data-page-callback]');
                    if (container && container.dataset.pageCallback) {
                        try {
                            const callback = eval(`(${container.dataset.pageCallback})`);
                            callback(page);
                        } catch (error) {
                            console.error('Pagination callback error:', error);
                        }
                    }
                } else if (e.target.classList.contains('add-review-btn')) {
                    const bookId = e.target.dataset.bookId;
                    UI.showAddReviewForm(bookId);
                } else if (e.target.classList.contains('view-all-checkouts-btn')) {
                    UI.showAllCheckouts();
                } else if (e.target.classList.contains('clear-all-filters-btn')) {
                    UI.clearAllFilters();
                } else if (e.target.classList.contains('back-to-dashboard-btn')) {
                    App.currentView = 'dashboard';
                    UI.showDashboard();
                } else if (e.target.classList.contains('browse-books-btn')) {
                    UI.showBooksPage();
                } else if (e.target.id === 'refreshAnalytics' || e.target.closest('#refreshAnalytics')) {
                    e.preventDefault();
                    await UI.loadAnalyticsData();
                    Utils.showAlert('Analytics data refreshed!', 'success');
                }
            });

            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.id === 'bookSearch') {
                    UI.searchBooks();
                }
            });

            document.addEventListener('change', (e) => {
                if (e.target.id === 'genreFilter') {
                    UI.handleGenreChange();
                } else if (e.target.id === 'sortBy') {
                    UI.handleSortChange();
                }
            });

            // Handle image loading errors - use fallback only when real images fail
            document.addEventListener('error', (e) => {
                if (e.target.tagName === 'IMG' && e.target.classList.contains('book-cover-img')) {
                    const fallback = e.target.getAttribute('data-fallback');
                                    if (fallback && e.target.src !== fallback) {
                    e.target.src = fallback;
                    } else if (!fallback) {
                        // If no fallback is set, generate one
                        const card = e.target.closest('.card');
                        const titleElement = card?.querySelector('.card-title');
                        if (titleElement) {
                            const bookTitle = titleElement.textContent;
                            e.target.src = UI.getPlaceholderImage(bookTitle, '300x400', 'Fiction');
                        }
                    }
                }
            }, true);

            // Show home page initially
            UI.showHomePage();
            
            // Initialize new functionality
            UI.initRatingStars();
            UI.initForms();
            UI.enhanceDateInputs();
            
            // Load user data when authenticated
            if (App.user) {
                UI.loadUserData();
            }
            
            // Add event listeners for buttons that were converted from inline handlers
            document.addEventListener('click', (e) => {
                if (e.target.id === 'refreshDashboardBtn' || e.target.closest('#refreshDashboardBtn')) {
                    e.preventDefault();
                    UI.forceGlobalRefresh();
                } else if (e.target.id === 'refreshCheckoutsBtn' || e.target.closest('#refreshCheckoutsBtn')) {
                    e.preventDefault();
                    UI.forceGlobalRefresh();
                } else if (e.target.id === 'testReturnBtn' || e.target.closest('#testReturnBtn')) {
                    e.preventDefault();
                    UI.showReturnModal(1, 'Test Book');
                }
            });
        });

        // Additional UI functions
        // Removed duplicate borrowBook function - using the complete version below

        // Advanced Search Functions
        UI.toggleAdvancedSearch = () => {
            const form = document.getElementById('advancedSearchForm');
            const isVisible = form.style.display !== 'none';
            form.style.display = isVisible ? 'none' : 'block';
            
            // Update button text
            const button = document.getElementById('advancedSearchToggle');
            if (button) {
                const icon = isVisible ? 'fas fa-filter' : 'fas fa-times';
                const text = isVisible ? 'Advanced Search' : 'Close Advanced';
                button.innerHTML = `<i class="${icon} me-2"></i>${text}`;
            }
        };

        UI.loadGenresForAdvancedSearch = async () => {
            try {
                const data = await Utils.makeRequest('/books?limit=1');
                if (data.filters && data.filters.available_genres) {
                    const advGenreSelect = document.getElementById('advGenre');
                    const genreSelect = document.getElementById('genreFilter');
                    
                    data.filters.available_genres.forEach(genre => {
                        // Add to basic genre filter if not already there
                        if (genreSelect && ![...genreSelect.options].some(option => option.value === genre)) {
                            const option = document.createElement('option');
                            option.value = genre;
                            option.textContent = genre;
                            genreSelect.appendChild(option);
                        }
                        
                        // Add to advanced genre filter
                        if (advGenreSelect) {
                            const option = document.createElement('option');
                            option.value = genre;
                            option.textContent = genre;
                            advGenreSelect.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading genres:', error);
            }
        };

        UI.performAdvancedSearch = async () => {
            const searchParams = new URLSearchParams();
            
            // Get all advanced search form values
            const title = document.getElementById('advTitle').value.trim();
            const author = document.getElementById('advAuthor').value.trim();
            const publisher = document.getElementById('advPublisher').value.trim();
            const genre = document.getElementById('advGenre').value;
            const isbn = document.getElementById('advISBN').value.trim();
            const yearFrom = document.getElementById('advYearFrom').value;
            const yearTo = document.getElementById('advYearTo').value;
            const minRating = document.getElementById('advMinRating').value;
            const maxRating = document.getElementById('advMaxRating').value;
            const availableOnly = document.getElementById('advAvailableOnly').checked;
            const ebookOnly = document.getElementById('advEbookOnly').checked;
            const sortBy = document.getElementById('advSortBy').value;
            
            // Build search parameters
            if (title) searchParams.append('title', title);
            if (author) searchParams.append('author_name', author);
            if (publisher) searchParams.append('publisher', publisher);
            if (genre) searchParams.append('genre', genre);
            if (isbn) searchParams.append('isbn', isbn);
            if (yearFrom) searchParams.append('publication_year_from', yearFrom);
            if (yearTo) searchParams.append('publication_year_to', yearTo);
            if (minRating) searchParams.append('min_rating', minRating);
            if (maxRating) searchParams.append('max_rating', maxRating);
            if (availableOnly) searchParams.append('available_only', 'true');
            if (ebookOnly) searchParams.append('is_ebook', 'true');
            
            searchParams.append('page', '1');
            searchParams.append('limit', '12');
            
            try {
                const container = document.getElementById('booksContainer');
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Searching...</span>
                        </div>
                        <p class="mt-2">Performing advanced search...</p>
                    </div>
                `;
                
                const data = await Utils.makeRequest(`/books/search/advanced?${searchParams}`);
                
                UI.displaySearchResults(data, true);
                UI.updateSearchResultsInfo(data, searchParams);
                
            } catch (error) {
                console.error('Advanced search error:', error);
                Utils.showAlert('Advanced search failed. Please try again.', 'danger');
                document.getElementById('booksContainer').innerHTML = 
                    '<div class="col-12 text-center"><p class="text-danger">Search failed. Please try again.</p></div>';
            }
        };

        UI.displaySearchResults = (data, isAdvancedSearch = false) => {
            const container = document.getElementById('booksContainer');
            
            if (!data.books || data.books.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="card">
                            <div class="card-body">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h5>No books found</h5>
                                <p class="text-muted">Try adjusting your search criteria or clear filters to see all books.</p>
                                <button class="btn btn-outline-primary clear-all-filters-btn">
                                    Clear All Filters
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.books.map(book => `
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <img src="" class="card-img-top book-cover book-cover-img" alt="${book.title}" 
                             data-cover-url="${book.cover_image_url || ''}"
                             style="height: 250px; object-fit: cover;" loading="lazy">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title" title="${book.title}">${book.title}</h6>
                            <p class="card-text text-muted small">by ${book.authors?.join(', ') || 'Unknown authors'}</p>
                            ${book.publisher ? `<p class="card-text text-muted small"><strong>Publisher:</strong> ${book.publisher}</p>` : ''}
                            ${book.publication_date ? `<p class="card-text text-muted small"><strong>Published:</strong> ${Utils.formatDate(book.publication_date)}</p>` : ''}
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="rating small">
                                        ${Utils.generateStarRating(book.average_rating)}
                                        <small class="text-muted">(${book.total_reviews})</small>
                                    </div>
                                    <span class="availability-badge ${book.is_available ? 'bg-success' : 'bg-danger'} text-white">
                                        ${book.is_available ? `${book.available_copies}/${book.total_copies}` : 'Unavailable'}
                                    </span>
                                </div>
                                ${book.is_ebook ? '<span class="badge bg-info mb-2">eBook</span>' : ''}
                                <button class="btn btn-primary btn-sm w-100 view-details-btn" data-book-id="${book.book_id}">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update pagination for advanced search
            if (isAdvancedSearch && data.pagination) {
                UI.updatePagination('booksPagination', data.pagination, (newPage) => {
                    // Re-run advanced search with new page
                    const currentParams = new URLSearchParams(window.location.search);
                    currentParams.set('page', newPage);
                    UI.performAdvancedSearchWithParams(currentParams);
                });
            }
        };

        UI.updateSearchResultsInfo = (data, searchParams) => {
            const infoDiv = document.getElementById('searchResultsInfo');
            const textSpan = document.getElementById('searchResultsText');
            
            if (searchParams.toString()) {
                const totalBooks = data.pagination?.total_books || data.books?.length || 0;
                const activeFilters = [];
                
                for (const [key, value] of searchParams.entries()) {
                    if (key !== 'page' && key !== 'limit' && value) {
                        const friendlyName = {
                            'title': 'Title',
                            'author_name': 'Author',
                            'publisher': 'Publisher',
                            'genre': 'Genre',
                            'isbn': 'ISBN',
                            'publication_year_from': 'Year From',
                            'publication_year_to': 'Year To',
                            'min_rating': 'Min Rating',
                            'max_rating': 'Max Rating',
                            'available_only': 'Available Only',
                            'is_ebook': 'eBooks Only'
                        }[key] || key;
                        
                        activeFilters.push(`${friendlyName}: ${value === 'true' ? 'Yes' : value}`);
                    }
                }
                
                textSpan.textContent = `Found ${totalBooks} book${totalBooks !== 1 ? 's' : ''} matching your search criteria. Active filters: ${activeFilters.join(', ')}`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        };

        UI.clearAdvancedSearch = () => {
            document.getElementById('advTitle').value = '';
            document.getElementById('advAuthor').value = '';
            document.getElementById('advPublisher').value = '';
            document.getElementById('advGenre').value = '';
            document.getElementById('advISBN').value = '';
            document.getElementById('advYearFrom').value = '';
            document.getElementById('advYearTo').value = '';
            document.getElementById('advMinRating').value = '';
            document.getElementById('advMaxRating').value = '';
            document.getElementById('advAvailableOnly').checked = false;
            document.getElementById('advEbookOnly').checked = false;
            document.getElementById('advSortBy').value = 'title';
        };

        UI.clearAllFilters = () => {
            // Clear basic search
            document.getElementById('bookSearch').value = '';
            document.getElementById('genreFilter').value = '';
            document.getElementById('sortBy').value = 'title';
            
            // Clear advanced search
            UI.clearAdvancedSearch();
            
            // Hide search results info
            document.getElementById('searchResultsInfo').style.display = 'none';
            
            // Load all books
            UI.loadBooks();
        };

        UI.performAdvancedSearchWithParams = async (searchParams) => {
            try {
                const data = await Utils.makeRequest(`/books/search/advanced?${searchParams}`);
                UI.displaySearchResults(data, true);
                UI.updateSearchResultsInfo(data, searchParams);
            } catch (error) {
                console.error('Advanced search error:', error);
                Utils.showAlert('Search failed. Please try again.', 'danger');
            }
        };

        // User Checkout and Review State Management
        App.userCheckouts = [];
        App.userReviews = [];

        // Load user's checkout and review data
        UI.loadUserData = async () => {
            if (!App.user) return;
            
            try {
                // Load user's checkouts
                const checkoutData = await Utils.makeRequest('/checkouts/user');
                App.userCheckouts = checkoutData.checkouts || [];
                
                // Load user's reviews
                const reviewData = await Utils.makeRequest('/reviews/user');
                App.userReviews = reviewData.reviews || [];
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        };

        // Check if user has borrowed a specific book
        UI.hasUserBorrowedBook = (bookId) => {
            return App.userCheckouts.some(checkout => 
                checkout.book_id === bookId && !checkout.is_returned
            );
        };

        // Check if user has reviewed a specific book
        UI.hasUserReviewedBook = (bookId) => {
            return App.userReviews.some(review => review.book_id === bookId);
        };

        // Get user's checkout for a specific book
        UI.getUserCheckout = (bookId) => {
            
            // Convert bookId to number for comparison
            const numericBookId = parseInt(bookId);
            
            const checkout = App.userCheckouts.find(checkout => {
                const checkoutBookId = parseInt(checkout.book_id);
                return checkoutBookId === numericBookId && !checkout.is_returned;
            });
            
            return checkout;
        };

        // Borrow Book Functions
        UI.showBorrowModal = (bookId, bookTitle) => {
            document.getElementById('borrowBookId').value = bookId;
            document.getElementById('borrowBookTitle').value = bookTitle;
            document.getElementById('borrowError').classList.add('d-none');
            
            const modal = new bootstrap.Modal(document.getElementById('borrowModal'));
            modal.show();
        };

        UI.borrowBook = async (bookId, loanPeriod, dueDate) => {
            try {
                const payload = dueDate ? { book_id: bookId, due_date: dueDate } : { book_id: bookId, loan_period_days: loanPeriod };
                const response = await Utils.makeRequest('/checkouts/borrow', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('borrowModal'));
                modal.hide();

                // Show success message
                Utils.showAlert('Book borrowed successfully! You will receive email reminders before the due date.', 'success');

                // Reload user data and refresh ALL relevant views
                await UI.loadUserData();
                
                // Refresh the current view to ensure UI is in sync
                if (App.currentView === 'checkouts') {
                    // If user is on checkouts page, refresh it completely
                    await UI.showAllCheckouts();
                } else if (App.currentView === 'dashboard') {
                    // If user is on dashboard, refresh it
                    UI.showDashboard();
                } else {
                    // Default: show book details
                    UI.showBookDetails(bookId);
                }
                
                // Force refresh ALL checkout-related displays for maximum synchronization
                await UI.refreshAllCheckoutDisplays();

            } catch (error) {
                document.getElementById('borrowError').textContent = error.message;
                document.getElementById('borrowError').classList.remove('d-none');
            }
        };

        // Return Book Functions
        UI.showReturnModal = async (bookId, bookTitle) => {
            
            // Ensure user checkouts are loaded
            if (!App.userCheckouts || App.userCheckouts.length === 0) {
                await UI.loadUserData();
            }
            
            const checkout = UI.getUserCheckout(bookId);
            
            if (!checkout) {
                
                // Try to find the checkout by book title as fallback
                const fallbackCheckout = App.userCheckouts.find(c => 
                    c.title && c.title.toLowerCase().includes(bookTitle.toLowerCase()) && !c.is_returned
                );
                
                if (fallbackCheckout) {ách                    // Use the fallback checkout
                    document.getElementById('returnBookId').value = fallbackCheckout.book_id;
                    document.getElementById('returnBookId').setAttribute('data-checkout-id', fallbackCheckout.checkout_id || '');
                    document.getElementById('returnBookTitle').value = fallbackCheckout.title;
                    document.getElementById('returnDueDate').value = new Date(fallbackCheckout.due_date).toLocaleDateString();
                    
                    // Continue with the fallback checkout
                    checkout = fallbackCheckout;
                } else {
                    Utils.showAlert('Checkout not found. Please refresh the page and try again.', 'danger');
                    return;
                }
            }

            document.getElementById('returnBookId').value = bookId;
            // Keep checkout_id for precise return API
            document.getElementById('returnBookId').setAttribute('data-checkout-id', checkout.checkout_id || '');
            document.getElementById('returnBookTitle').value = bookTitle;
            document.getElementById('returnDueDate').value = new Date(checkout.due_date).toLocaleDateString();
            
            // Calculate and display status
            const today = new Date();
            const dueDate = new Date(checkout.due_date);
            const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            
            const statusDiv = document.getElementById('returnStatus');
            if (daysDiff < 0) {
                statusDiv.className = 'alert alert-danger checkout-status late';
                statusDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Overdue!</strong> This book is ${Math.abs(daysDiff)} days late.
                `;
            } else if (daysDiff <= 2) {
                statusDiv.className = 'alert alert-warning checkout-status warning';
                statusDiv.innerHTML = `
                    <i class="fas fa-clock me-2"></i>
                    <strong>Due Soon!</strong> This book is due in ${daysDiff} day${daysDiff === 1 ? '' : 's'}.
                `;
            } else {
                statusDiv.className = 'alert alert-success checkout-status on-time';
                statusDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>On Time!</strong> This book is due in ${daysDiff} days.
                `;
            }

            document.getElementById('returnError').classList.add('d-none');
            
            const modal = new bootstrap.Modal(document.getElementById('returnModal'));
            modal.show();
        };

        UI.returnBook = async (bookId) => {
            try {
                const hidden = document.getElementById('returnBookId');
                const checkoutIdAttr = hidden.getAttribute('data-checkout-id');
                const payload = checkoutIdAttr ? { checkout_id: parseInt(checkoutIdAttr) } : { book_id: bookId };
                const response = await Utils.makeRequest('/checkouts/return', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('returnModal'));
                modal.hide();

                // Show success message
                const message = response.is_late ? 
                    'Book returned successfully! Late return fee: $' + response.late_fee :
                    'Book returned successfully! Thank you for returning on time.';
                Utils.showAlert(message, 'success');

                // Reload user data and refresh ALL relevant views
                await UI.loadUserData();
                
                // Refresh the current view to ensure UI is in sync
                if (App.currentView === 'checkouts') {
                    // If user is on checkouts page, refresh it completely
                    await UI.showAllCheckouts();
                } else if (App.currentView === 'dashboard') {
                    // If user is on dashboard, refresh it
                    UI.showDashboard();
                } else {
                    // Default: show book details
                    UI.showBookDetails(bookId);
                }
                
                // Force refresh ALL checkout-related displays for maximum synchronization
                await UI.refreshAllCheckoutDisplays();

            } catch (error) {
                document.getElementById('returnError').textContent = error.message;
                document.getElementById('returnError').classList.remove('d-none');
            }
        };

        // Review Book Functions
        UI.showReviewModal = (bookId, bookTitle) => {
            document.getElementById('reviewBookId').value = bookId;
            document.getElementById('reviewBookTitle').value = bookTitle;
            document.getElementById('reviewRating').value = '';
            document.getElementById('reviewComment').value = '';
            document.getElementById('reviewError').classList.add('d-none');
            
            // Reset stars
            document.querySelectorAll('#reviewModal .stars i').forEach(star => {
                star.className = 'far fa-star';
            });
            
            const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
            modal.show();
        };

        // Missing function to handle "Add Review" button clicks
        UI.showAddReviewForm = async (bookId) => {
            try {
                // Get book details to retrieve the title
                const bookData = await Utils.makeRequest(`/books/${bookId}`);
                const bookTitle = bookData.book.title;
                
                // Use the existing showReviewModal function
                UI.showReviewModal(bookId, bookTitle);
            } catch (error) {
                console.error('Error loading book details for review:', error);
                Utils.showAlert('Failed to load book details. Please try again.', 'danger');
            }
        };

        UI.submitReview = async (bookId, rating, comment) => {
            try {
                const response = await Utils.makeRequest('/reviews', {
                    method: 'POST',
                    body: JSON.stringify({
                        book_id: bookId,
                        rating: rating,
                        comment: comment
                    })
                });

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('reviewModal'));
                modal.hide();

                // Show success message
                Utils.showAlert('Review submitted successfully! Thank you for your feedback.', 'success');

                // Reload user data and refresh ALL relevant views
                await UI.loadUserData();
                
                // Refresh the current view to ensure UI is in sync
                if (App.currentView === 'reviews') {
                    // If user is on reviews page, refresh it
                    UI.showMyReviews();
                } else if (App.currentView === 'dashboard') {
                    // If user is on dashboard, refresh it
                    UI.showDashboard();
                } else {
                    // Default: show book details
                    UI.showBookDetails(bookId);
                }

            } catch (error) {
                document.getElementById('reviewError').textContent = error.message;
                document.getElementById('reviewError').classList.remove('d-none');
            }
        };

        // Utility function to refresh all checkout-related displays
        UI.refreshAllCheckoutDisplays = async () => {
            try {
                // Force refresh any active checkouts display
                if (document.getElementById('checkoutsContainer')) {
                    await UI.showAllCheckouts();
                }
                
                // Also refresh dashboard if it's visible
                if (App.currentView === 'dashboard') {
                    UI.showDashboard();
                }
                
                // Force refresh any book details that might show checkout status
                if (App.currentBookId) {
                    UI.showBookDetails(App.currentBookId);
                }
            } catch (error) {
                console.error('Error refreshing checkout displays:', error);
            }
        };

        // Global refresh function for maximum synchronization
        UI.forceGlobalRefresh = async () => {
            try {
                
                // Reload all user data
                await UI.loadUserData();
                
                // Refresh based on current view
                switch (App.currentView) {
                    case 'checkouts':
                        await UI.showAllCheckouts();
                        break;
                    case 'dashboard':
                        UI.showDashboard();
                        break;
                    case 'books':
                        UI.showBooksPage();
                        break;
                    case 'analytics':
                        UI.showAnalyticsPage();
                        break;
                    case 'reviews':
                        UI.showMyReviews();
                        break;
                    case 'admin':
                        await UI.showAdminPanel();
                        break;
                    default:
                        // If no specific view, refresh dashboard
                        UI.showDashboard();
                }
                
            } catch (error) {
                console.error('❌ Error during global refresh:', error);
            }
        };

        // Initialize rating stars functionality
        UI.initRatingStars = () => {
            document.addEventListener('click', (e) => {
                if (e.target.closest('#reviewModal .stars')) {
                    const stars = e.target.closest('#reviewModal .stars').querySelectorAll('i');
                    const clickedRating = parseInt(e.target.dataset.rating);
                    
                    stars.forEach((star, index) => {
                        if (index < clickedRating) {
                            star.className = 'fas fa-star';
                        } else {
                            star.className = 'far fa-star';
                        }
                    });
                    
                    document.getElementById('reviewRating').value = clickedRating;
                }
            });
        };

        // Initialize form submissions
        UI.initForms = () => {
            // Borrow form
            document.getElementById('borrowForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const bookId = parseInt(document.getElementById('borrowBookId').value);
                const loanPeriod = parseInt(document.getElementById('loanPeriod').value);
                const dueDate = document.getElementById('dueDatePicker').value;
                await UI.borrowBook(bookId, loanPeriod, dueDate);
            });

            // Return form
            document.getElementById('returnForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const bookId = parseInt(document.getElementById('returnBookId').value);
                await UI.returnBook(bookId);
            });

            // Review form
            document.getElementById('reviewForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const bookId = parseInt(document.getElementById('reviewBookId').value);
                const rating = parseInt(document.getElementById('reviewRating').value);
                const comment = document.getElementById('reviewComment').value;
                
                if (!rating) {
                    document.getElementById('reviewError').textContent = 'Please select a rating.';
                    document.getElementById('reviewError').classList.remove('d-none');
                    return;
                }
                
                await UI.submitReview(bookId, rating, comment);
            });

            // Delegate admin forms (Add, Inventory, Retire, Reports)
            document.addEventListener('submit', async (e) => {
                if (e.target && e.target.id === 'addBookForm') {
                    e.preventDefault();
                    try {
                        // If a file is selected, convert it to a data URL for upload
                        const fileInput = document.getElementById('add_cover_file');
                        let coverDataUrl = null;
                        if (fileInput && fileInput.files && fileInput.files[0]) {
                            coverDataUrl = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = () => resolve(reader.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(fileInput.files[0]);
                            });
                        }
                        const authorsRaw = document.getElementById('add_authors').value.trim();
                        const authors = authorsRaw ? authorsRaw.split(';').map(s => s.trim()).filter(Boolean).map(name => ({ name })) : [];
                        const payload = {
                            title: document.getElementById('add_title').value.trim(),
                            isbn: document.getElementById('add_isbn').value.trim() || null,
                            publisher: document.getElementById('add_publisher').value.trim() || null,
                            publication_date: (() => {
                                const dateValue = document.getElementById('add_pubdate').value;
                                if (!dateValue) return null;
                                
                                // If it's already in yyyy-mm-dd format, use it as is
                                if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                    return dateValue;
                                }
                                
                                // If it's in mm/dd/yyyy format, convert to yyyy-mm-dd
                                if (dateValue.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                                    const [month, day, year] = dateValue.split('/');
                                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                }
                                
                                // If it's in mm-dd-yyyy format, convert to yyyy-mm-dd
                                if (dateValue.match(/^\d{1,2}-\d{1,2}-\d{4}$/)) {
                                    const [month, day, year] = dateValue.split('-');
                                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                }
                                
                                return null;
                            })(),
                            genre: document.getElementById('add_genre').value.trim() || null,
                            language: document.getElementById('add_language').value.trim() || 'English',
                            pages: parseInt(document.getElementById('add_pages').value) || null,
                            description: document.getElementById('add_description').value.trim() || null,
                            total_copies: parseInt(document.getElementById('add_copies').value) || 1,
                            is_ebook: document.getElementById('add_is_ebook').checked,
                            cover_image_url: coverDataUrl || (document.getElementById('add_cover').value.trim() || null),
                            authors
                        };
                        
                        
                        // Test cover image URL if provided
                        if (payload.cover_image_url) {
                            try {
                                const imgTest = new Image();
                                imgTest.onload = async () => {
                                    // Image loads successfully, proceed with book addition
                                    await Utils.makeRequest('/admin/books', { method: 'POST', body: JSON.stringify(payload) });
                                    Utils.showAlert('Book added successfully with cover image!', 'success');
                                    // Refresh the current view to show the new book
                                    if (App.currentView === 'books') {
                                        UI.showBooksPage();
                                    } else if (App.currentView === 'dashboard') {
                                        UI.showDashboard();
                                    }
                                };
                                imgTest.onerror = async () => {
                                    // Image failed to load, ask user if they want to continue
                                    if (confirm('The cover image URL appears to be invalid. Do you want to add the book without a cover image?')) {
                                        payload.cover_image_url = null;
                                        await Utils.makeRequest('/admin/books', { method: 'POST', body: JSON.stringify(payload) });
                                        Utils.showAlert('Book added successfully (without cover image).', 'success');
                                        // Refresh the current view to show the new book
                                        if (App.currentView === 'books') {
                                            UI.showBooksPage();
                                        } else if (App.currentView === 'dashboard') {
                                            UI.showDashboard();
                                        }
                                    }
                                };
                                imgTest.src = payload.cover_image_url;
                            } catch (error) {
                                // If image test fails, proceed without cover image
                                payload.cover_image_url = null;
                                await Utils.makeRequest('/admin/books', { method: 'POST', body: JSON.stringify(payload) });
                                Utils.showAlert('Book added successfully (without cover image).', 'success');
                                // Refresh the current view to show the new book
                                if (App.currentView === 'books') {
                                    UI.showBooksPage();
                                } else if (App.currentView === 'dashboard') {
                                    UI.showDashboard();
                                }
                            }
                        } else {
                            // No cover image, proceed normally
                            await Utils.makeRequest('/admin/books', { method: 'POST', body: JSON.stringify(payload) });
                            Utils.showAlert('Book added successfully!', 'success');
                            // Refresh the current view to show the new book
                            if (App.currentView === 'books') {
                                UI.showBooksPage();
                            } else if (App.currentView === 'dashboard') {
                                UI.showDashboard();
                            }
                        }
                    } catch (err) { Utils.showAlert(err.message || 'Failed to add book', 'danger'); }
                } else if (e.target && e.target.id === 'inventoryForm') {
                    e.preventDefault();
                    try {
                        const id = parseInt(document.getElementById('inv_book_id').value);
                        const total = parseInt(document.getElementById('inv_total').value);
                        await Utils.makeRequest(`/admin/books/${id}/inventory`, { method: 'PUT', body: JSON.stringify({ total_copies: total }) });
                        Utils.showAlert('Inventory updated successfully.', 'success');
                        // Refresh the current view to show updated availability
                        if (App.currentView === 'books') {
                            UI.showBooksPage();
                        } else if (App.currentView === 'dashboard') {
                            UI.showDashboard();
                        }
                    } catch (err) { Utils.showAlert(err.message || 'Failed to update inventory', 'danger'); }
                } else if (e.target && e.target.id === 'retireForm') {
                    e.preventDefault();
                    try {
                        const id = parseInt(document.getElementById('retire_book_id').value);
                        await Utils.makeRequest(`/admin/books/${id}/retire`, { method: 'PUT' });
                        Utils.showAlert('Book retired successfully.', 'success');
                        // Refresh the current view to show updated status
                        if (App.currentView === 'books') {
                            UI.showBooksPage();
                        } else if (App.currentView === 'dashboard') {
                            UI.showDashboard();
                        }
                    } catch (err) { Utils.showAlert(err.message || 'Failed to retire book', 'danger'); }
                } else if (e.target && e.target.id === 'reportsForm') {
                    e.preventDefault();
                    try {
                        const type = document.getElementById('rep_type').value;
                        const start = document.getElementById('rep_start').value;
                        const end = document.getElementById('rep_end').value;
                        const limit = parseInt(document.getElementById('rep_limit').value) || 10;
                        const params = new URLSearchParams({ report_type: type, start_date: start, end_date: end, limit });
                        const data = await Utils.makeRequest(`/admin/reports?${params.toString()}`);
                        UI.renderReportResults(type, data);
                    } catch (err) { Utils.showAlert(err.message || 'Failed to load report', 'danger'); }
                } else if (e.target && e.target.id === 'updateCoverForm') {
                    e.preventDefault();
                    await UI.handleCoverUpdate();
                }
            });
        };

        // Simple My Reviews page (list current user's reviews)
        UI.showMyReviews = async () => {
            if (!App.user) {
                Utils.showAlert('Please log in to view your reviews.', 'warning');
                return;
            }
            document.getElementById('mainContent').innerHTML = `
                <div class="container my-4">
                    <div class="row">
                        <div class="col-12">
                            <button class="btn btn-outline-secondary mb-3 back-to-dashboard-btn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </button>
                        </div>
                    </div>
                    <h2><i class="fas fa-star me-2"></i>My Reviews</h2>
                    <div id="myReviewsContainer"><div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div></div>
                </div>`;
            try {
                const data = await Utils.makeRequest('/reviews/user');
                const container = document.getElementById('myReviewsContainer');
                if (!data.reviews || data.reviews.length === 0) {
                    container.innerHTML = '<p class="text-muted">No reviews yet.</p>';
                    return;
                }
                container.innerHTML = data.reviews.map(r => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">${r.book_title}</h5>
                            <div class="rating mb-2">${Utils.generateStarRating(r.rating)}</div>
                            ${r.comment ? `<p class="card-text">${r.comment}</p>` : ''}
                            <small class="text-muted">${Utils.formatDate(r.review_date)}</small>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                Utils.showAlert('Failed to load your reviews.', 'danger');
            }
        };


        // Authentication Helper Functions
        UI.checkAuthStatus = async () => {
            const token = localStorage.getItem('library_token');
            if (!token) {
                return { valid: false, reason: 'No token' };
            }
            
            try {
                const response = await fetch('/api/admin/debug-auth', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { valid: true, user: data.user };
                } else if (response.status === 401) {
                    // Token is invalid or expired
                    localStorage.removeItem('library_token');
                    return { valid: false, reason: 'Token expired or invalid' };
                } else {
                    // Other errors
                    return { valid: false, reason: `HTTP ${response.status}: ${response.statusText}` };
                }
            } catch (error) {
                return { valid: false, reason: error.message };
            }
        };

        // Removed refreshAuthIfNeeded to prevent auto-logout conflicts

        // Cover Management Functions
        UI.loadBooksForCoverUpdate = async () => {
            try {
                const data = await Utils.makeRequest('/books?limit=1000');
                const select = document.getElementById('cover_book_id');
                select.innerHTML = '<option value="">Choose a book...</option>';
                
                data.books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.book_id;
                    option.textContent = `${book.title} by ${book.authors.join(', ')}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load books:', error);
                Utils.showAlert('Failed to load books list', 'danger');
            }
        };

        UI.showCurrentCover = async (bookId) => {
            try {
                const data = await Utils.makeRequest(`/books/${bookId}`);
                const preview = document.getElementById('currentCoverPreview');
                
                if (data.book.cover_image_url) {
                    preview.innerHTML = `
                        <img src="${data.book.cover_image_url}" class="img-thumbnail" style="max-width: 150px; max-height: 200px;" alt="Current Cover">
                        <div class="mt-2">
                            <small class="text-muted">Current cover for "${data.book.title}"</small>
                        </div>
                    `;
                } else {
                    preview.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-image fa-3x text-muted mb-2"></i>
                            <div><small class="text-muted">No cover image set</small></div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load book details:', error);
                document.getElementById('currentCoverPreview').innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <div><small>Failed to load book details</small></div>
                    </div>
                `;
            }
        };

        UI.handleCoverUpdate = async () => {
            const updateButton = document.querySelector('#updateCoverForm button[type="submit"]');
            const originalButtonText = updateButton.innerHTML;
            
            try {
                const bookId = document.getElementById('cover_book_id').value;
                const fileInput = document.getElementById('cover_file_input');
                const urlInput = document.getElementById('cover_url_input');
                
                if (!bookId) {
                    Utils.showAlert('Please select a book', 'warning');
                    return;
                }
                
                // Show loading state
                updateButton.disabled = true;
                updateButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating Cover...';
                
                let coverUrl = '';
                
                // Check if file is uploaded
                if (fileInput.files && fileInput.files[0]) {
                    const formData = new FormData();
                    formData.append('coverImage', fileInput.files[0]);
                    
                    const token = localStorage.getItem('library_token');
                    if (!token) {
                        throw new Error('Authentication required. Please login again.');
                    }
                    
                    
                    const uploadResponse = await fetch('/api/admin/upload-cover', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json().catch(() => ({}));
                        if (uploadResponse.status === 401) {
                            throw new Error('Authentication failed. Please login again.');
                        }
                        throw new Error(errorData.error?.message || 'Failed to upload cover image');
                    }
                    
                    const uploadData = await uploadResponse.json();
                    coverUrl = uploadData.data.fullUrl;
                    
                } else if (urlInput.value.trim()) {
                    // Use URL if provided
                    coverUrl = urlInput.value.trim();
                } else {
                    Utils.showAlert('Please upload a file or provide an image URL', 'warning');
                    return;
                }
                
                // Update the book cover
                const updateResponse = await Utils.makeRequest(`/admin/books/${bookId}/cover`, {
                    method: 'PUT',
                    body: JSON.stringify({ cover_image_url: coverUrl })
                });
                
                // Show success notification with more details
                const bookTitle = document.getElementById('cover_book_id').selectedOptions[0]?.textContent || 'Selected book';
                Utils.showAlert(`✅ Book cover updated successfully for "${bookTitle}"!`, 'success');
                
                // Show additional success message in the cover update history
                const historyDiv = document.getElementById('coverUpdateHistory');
                const timestamp = new Date().toLocaleString();
                const successMessage = `
                    <div class="alert alert-success alert-dismissible fade show mb-2" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Cover Updated Successfully!</strong><br>
                        <small>Book: ${bookTitle}</small><br>
                        <small>Time: ${timestamp}</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                historyDiv.innerHTML = successMessage + historyDiv.innerHTML;
                
                // Refresh the current cover preview
                await UI.showCurrentCover(bookId);
                
                // Clear form
                fileInput.value = '';
                urlInput.value = '';
                document.getElementById('newCoverPreview').style.display = 'none';
                
                // Refresh the current view to show updated cover
                if (App.currentView === 'books') {
                    UI.showBooksPage();
                } else if (App.currentView === 'dashboard') {
                    UI.showDashboard();
                }
                
            } catch (error) {
                console.error('Cover update error:', error);
                Utils.showAlert(error.message || 'Failed to update book cover', 'danger');
            } finally {
                // Reset button state
                updateButton.disabled = false;
                updateButton.innerHTML = originalButtonText;
            }
        };

        // Admin Panel view and report renderer
        UI.showAdminPanel = async () => {
            // Always check token first - don't rely on cached user data
            const token = localStorage.getItem('library_token');
            
            if (!token) {
                Utils.showAlert('Please login to access admin panel', 'warning');
                return;
            }
            
            // Check if user is already loaded and is staff
            if (App.user && (App.user.user_type === 'staff' || App.user.user_type === 'admin')) {
                // User is already loaded and is staff, proceed directly
            } else {
                // Load user data
                try {
                    const data = await Utils.makeRequest('/auth/profile');
                    App.user = data.user;
                } catch (error) {
                    console.error('❌ Failed to load user data:', error);
                    Utils.showAlert('Failed to load user data', 'danger');
                    return;
                }
                
            if (!App.user || (App.user.user_type !== 'staff' && App.user.user_type !== 'admin')) {
                Utils.showAlert('Staff access required.', 'warning');
                return;
                }
            }
            document.getElementById('mainContent').innerHTML = `
                <div class="container my-4">
                    <h2 class="mb-3"><i class="fas fa-cog me-2"></i>Admin Panel</h2>
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-add">Add Book</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-covers">Cover Management</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-inv">Update Inventory</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-retire">Retire Book</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-reports">Reports</a></li>
                    </ul>
                    <div class="tab-content border border-top-0 p-3 bg-white">
                        <div class="tab-pane fade show active" id="tab-add">
                            <form id="addBookForm" class="row g-3">
                                <div class="col-md-6"><label class="form-label">Title</label><input id="add_title" class="form-control" required></div>
                                <div class="col-md-3"><label class="form-label">ISBN</label><input id="add_isbn" class="form-control"></div>
                                <div class="col-md-3"><label class="form-label">Publisher</label><input id="add_publisher" class="form-control"></div>
                                                                 <div class="col-md-3">
                                     <label class="form-label">Publication Date</label>
                                     <div class="input-group">
                                         <input id="add_pubdate" type="text" class="form-control" placeholder="mm/dd/yyyy">
                                         <button class="btn btn-outline-secondary" type="button" id="datePickerBtn">
                                             <i class="fas fa-calendar"></i>
                                         </button>
                                     </div>
                                     <small class="form-text text-muted">You can type (mm/dd/yyyy) or use the calendar</small>
                                 </div>
                                <div class="col-md-3"><label class="form-label">Genre</label><input id="add_genre" class="form-control"></div>
                                <div class="col-md-3"><label class="form-label">Language</label><input id="add_language" class="form-control" value="English"></div>
                                <div class="col-md-3"><label class="form-label">Pages</label><input id="add_pages" type="number" class="form-control"></div>
                                <div class="col-12"><label class="form-label">Description</label><textarea id="add_description" class="form-control" rows="3"></textarea></div>
                                <div class="col-md-3"><label class="form-label">Total Copies</label><input id="add_copies" type="number" class="form-control" value="1" min="1" required></div>
                                <div class="col-md-6">
                                    <label class="form-label">Cover Image</label>
                                    <div class="input-group">
                                        <input id="add_cover" class="form-control" placeholder="Paste image URL here...">
                                        <button class="btn btn-outline-secondary" type="button" id="previewCoverBtn">
                                            <i class="fas fa-eye"></i> Preview
                                        </button>
                                        <input id="add_cover_file" type="file" accept="image/*" class="form-control" style="max-width: 260px;" />
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Paste any image URL, or upload from your computer.
                                    </small>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#coverHelp">
                                            <i class="fas fa-question-circle me-1"></i>How to get image URLs?
                                        </button>
                                        <div class="collapse mt-2" id="coverHelp">
                                            <div class="card card-body bg-light">
                                                <h6><i class="fas fa-lightbulb me-1"></i>Image URL Tips:</h6>
                                                <ul class="mb-0 small">
                                                    <li><strong>Google Images:</strong> Right-click image → "Copy image address"</li>
                                                    <li><strong>Your Computer:</strong> Upload to Google Drive → Right-click → "Copy link"</li>
                                                    <li><strong>Online Storage:</strong> Use services like Imgur, Dropbox, or OneDrive</li>
                                                    <li><strong>Test First:</strong> Use the Preview button to verify the image loads</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="coverPreview" class="mt-2" style="display: none;">
                                        <img id="coverPreviewImg" class="img-thumbnail" style="max-width: 150px; max-height: 200px;" alt="Cover Preview">
                                        <div class="mt-1">
                                            <small class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                Image preview successful! This image will be displayed for the book.
                                            </small>
                                        </div>
                                    </div>
                                    <div id="coverError" class="mt-2" style="display: none;">
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <span id="coverErrorText">Image could not be loaded. Please check the URL.</span>
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-3 d-flex align-items-end"><div class="form-check"><input id="add_is_ebook" class="form-check-input" type="checkbox"><label class="form-check-label">eBook</label></div></div>
                                <div class="col-12"><label class="form-label">Authors (separate by ';' e.g., 'Frank Herbert; Someone Else')</label><input id="add_authors" class="form-control" required></div>
                                <div class="col-12"><button class="btn btn-primary" type="submit"><i class="fas fa-plus me-2"></i>Add Book</button></div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="tab-covers">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5><i class="fas fa-image me-2"></i>Update Book Cover</h5>
                                    <form id="updateCoverForm" class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">Select Book</label>
                                            <select id="cover_book_id" class="form-select" required>
                                                <option value="">Choose a book...</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Current Cover</label>
                                            <div id="currentCoverPreview" class="text-center p-3 border rounded bg-light">
                                                <small class="text-muted">Select a book to see current cover</small>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Upload New Cover Image</label>
                                            <input id="cover_file_input" type="file" accept="image/*" class="form-control" required>
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Supported formats: JPEG, JPG, PNG, GIF, WebP (Max: 5MB)
                                            </small>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Or Paste Image URL</label>
                                            <div class="input-group">
                                                <input id="cover_url_input" class="form-control" placeholder="https://example.com/image.jpg">
                                                <button class="btn btn-outline-secondary" type="button" id="previewUrlBtn">
                                                    <i class="fas fa-eye"></i> Preview
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div id="newCoverPreview" class="text-center p-3 border rounded bg-light" style="display: none;">
                                                <img id="newCoverPreviewImg" class="img-thumbnail" style="max-width: 150px; max-height: 200px;" alt="New Cover Preview">
                                                <div class="mt-2">
                                                    <small class="text-success">
                                                        <i class="fas fa-check-circle me-1"></i>
                                                        New cover preview
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <button class="btn btn-primary" type="submit">
                                                <i class="fas fa-upload me-2"></i>Update Cover
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <h5><i class="fas fa-list me-2"></i>Recent Cover Updates</h5>
                                    <div id="coverUpdateHistory" class="border rounded p-3 bg-light">
                                        <small class="text-muted">Cover update history will appear here</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-inv">
                            <form id="inventoryForm" class="row g-3">
                                <div class="col-md-4"><label class="form-label">Book ID</label><input id="inv_book_id" type="number" class="form-control" required></div>
                                <div class="col-md-4"><label class="form-label">New Total Copies</label><input id="inv_total" type="number" class="form-control" min="1" required></div>
                                <div class="col-12"><button class="btn btn-warning" type="submit"><i class="fas fa-warehouse me-2"></i>Update Inventory</button></div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="tab-retire">
                            <form id="retireForm" class="row g-3">
                                <div class="col-md-4"><label class="form-label">Book ID</label><input id="retire_book_id" type="number" class="form-control" required></div>
                                <div class="col-12"><button class="btn btn-danger" type="submit"><i class="fas fa-ban me-2"></i>Retire Book</button></div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="tab-reports">
                            <form id="reportsForm" class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Report Type</label>
                                    <select id="rep_type" class="form-select">
                                        <option value="most_borrowed">Most Borrowed Books</option>
                                        <option value="top_readers">Top Active Readers</option>
                                        <option value="low_availability">Low Availability</option>
                                    </select>
                                </div>
                                <div class="col-md-3"><label class="form-label">Start</label><input id="rep_start" type="date" class="form-control"></div>
                                <div class="col-md-3"><label class="form-label">End</label><input id="rep_end" type="date" class="form-control"></div>
                                <div class="col-md-2"><label class="form-label">Limit</label><input id="rep_limit" type="number" class="form-control" value="10"></div>
                                <div class="col-12"><button class="btn btn-info" type="submit"><i class="fas fa-chart-line me-2"></i>Run</button></div>
                            </form>
                            <div id="reportsResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>`;
            
            // Initialize cover management functionality
            UI.loadBooksForCoverUpdate();
            
            // Add event listeners for cover management
            document.getElementById('cover_book_id').addEventListener('change', async (e) => {
                if (e.target.value) {
                    await UI.showCurrentCover(e.target.value);
                } else {
                    document.getElementById('currentCoverPreview').innerHTML = `
                        <small class="text-muted">Select a book to see current cover</small>
                    `;
                }
            });
            
            // File input change handler
            document.getElementById('cover_file_input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const preview = document.getElementById('newCoverPreview');
                        const img = document.getElementById('newCoverPreviewImg');
                        img.src = event.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // URL preview button
            document.getElementById('previewUrlBtn').addEventListener('click', () => {
                const url = document.getElementById('cover_url_input').value.trim();
                if (url) {
                    const preview = document.getElementById('newCoverPreview');
                    const img = document.getElementById('newCoverPreviewImg');
                    img.src = url;
                    preview.style.display = 'block';
                } else {
                    Utils.showAlert('Please enter an image URL', 'warning');
                }
            });
        };

        UI.renderReportResults = (type, data) => {
            const container = document.getElementById('reportsResult');
            try {
                const payload = data?.data || data || {};
                if (type === 'most_borrowed') {
                    const rows = (payload.most_borrowed_books || payload.popular_books || []).map(b => `<tr><td>${b.book_id}</td><td>${b.title}</td><td>${(b.authors || '').toString()}</td><td>${b.checkout_count || b.total_borrowed || ''}</td></tr>`).join('');
                    container.innerHTML = `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>ID</th><th>Title</th><th>Authors</th><th>Borrowed</th></tr></thead><tbody>${rows}</tbody></table></div>`;
                } else if (type === 'top_readers') {
                    const rows = (payload.top_readers || []).map(u => `<tr><td>${u.user_id}</td><td>${u.username || ''}</td><td>${u.total_checkouts}</td></tr>`).join('');
                    container.innerHTML = `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>User ID</th><th>User</th><th>Checkouts</th></tr></thead><tbody>${rows}</tbody></table></div>`;
                } else {
                    const rows = (payload.low_availability_books || []).map(b => `<tr><td>${b.book_id}</td><td>${b.title}</td><td>${b.available_copies}</td><td>${b.total_copies}</td></tr>`).join('');
                    container.innerHTML = `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>ID</th><th>Title</th><th>Available</th><th>Total</th></tr></thead><tbody>${rows}</tbody></table></div>`;
                }
            } catch (_) { container.innerHTML = `<div class="alert alert-danger">Failed to render report.</div>`; }
        };

        // Enhance date input functionality for better user experience
        UI.enhanceDateInputs = () => {
            // Get all date inputs
            const dateInputs = document.querySelectorAll('input[type="date"]');
            
            dateInputs.forEach(input => {
                // Add keyboard shortcuts
                input.addEventListener('keydown', (e) => {
                    // Enter key to open date picker
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (typeof input.showPicker === 'function') {
                            input.showPicker();
                        } else {
                            input.focus();
                        }
                    }
                    
                    // Today's date shortcut (Ctrl+T)
                    if (e.ctrlKey && e.key === 't') {
                        e.preventDefault();
                        const today = new Date().toISOString().split('T')[0];
                        input.value = today;
                        input.dispatchEvent(new Event('change'));
                    }
                });

                // Add input validation and formatting
                input.addEventListener('input', (e) => {
                    const value = e.target.value;
                    
                    // Allow typing in mm/dd/yyyy format and convert to yyyy-mm-dd
                    if (value.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        const [month, day, year] = value.split('/');
                        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        input.value = formattedDate;
                        input.dispatchEvent(new Event('change'));
                    }
                    
                    // Also handle mm-dd-yyyy format
                    if (value.match(/^\d{1,2}-\d{1,2}-\d{4}$/)) {
                        const [month, day, year] = value.split('-');
                        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        input.value = formattedDate;
                        input.dispatchEvent(new Event('change'));
                    }
                });

                // Handle paste events for date formatting
                input.addEventListener('paste', (e) => {
                    setTimeout(() => {
                        const value = input.value;
                        if (value.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                            const [month, day, year] = value.split('/');
                            const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            input.value = formattedDate;
                            input.dispatchEvent(new Event('change'));
                        }
                    }, 10);
                });

                // Add placeholder text for better UX
                if (!input.placeholder) {
                    input.placeholder = 'mm/dd/yyyy or click calendar';
                }
            });

            // Handle the publication date text input specifically
            const pubDateInput = document.getElementById('add_pubdate');
            if (pubDateInput) {
                // Add input validation and formatting for text input
                pubDateInput.addEventListener('input', (e) => {
                    const value = e.target.value;
                    
                    // Allow typing in mm/dd/yyyy format and convert to yyyy-mm-dd
                    if (value.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        const [month, day, year] = value.split('/');
                        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        pubDateInput.value = formattedDate;
                        pubDateInput.dispatchEvent(new Event('change'));
                    }
                    
                    // Also handle mm-dd-yyyy format
                    if (value.match(/^\d{1,2}-\d{1,2}-\d{4}$/)) {
                        const [month, day, year] = value.split('-');
                        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        pubDateInput.value = formattedDate;
                        pubDateInput.dispatchEvent(new Event('change'));
                    }
                });

                // Handle paste events for date formatting
                pubDateInput.addEventListener('paste', (e) => {
                    setTimeout(() => {
                        const value = pubDateInput.value;
                        if (value.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                            const [month, day, year] = value.split('/');
                            const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            pubDateInput.value = formattedDate;
                            pubDateInput.dispatchEvent(new Event('change'));
                        }
                    }, 10);
                });

                // Add keyboard shortcuts
                pubDateInput.addEventListener('keydown', (e) => {
                    // Today's date shortcut (Ctrl+T)
                    if (e.ctrlKey && e.key === 't') {
                        e.preventDefault();
                        const today = new Date();
                        const month = (today.getMonth() + 1).toString().padStart(2, '0');
                        const day = today.getDate().toString().padStart(2, '0');
                        const year = today.getFullYear();
                        pubDateInput.value = `${month}/${day}/${year}`;
                        pubDateInput.dispatchEvent(new Event('change'));
                    }
                });
            }

            // Add event listener for date picker button
            const datePickerBtn = document.getElementById('datePickerBtn');
            if (datePickerBtn) {
                datePickerBtn.addEventListener('click', () => {
                    // Create a temporary date input for the picker
                    const tempDateInput = document.createElement('input');
                    tempDateInput.type = 'date';
                    tempDateInput.style.position = 'absolute';
                    tempDateInput.style.left = '-9999px';
                    document.body.appendChild(tempDateInput);
                    
                    tempDateInput.addEventListener('change', (e) => {
                        const selectedDate = e.target.value;
                        if (selectedDate) {
                            const date = new Date(selectedDate);
                            const month = (date.getMonth() + 1).toString().padStart(2, '0');
                            const day = date.getDate().toString().padStart(2, '0');
                            const year = date.getFullYear();
                            const pubDateInput = document.getElementById('add_pubdate');
                            if (pubDateInput) {
                                pubDateInput.value = `${month}/${day}/${year}`;
                                pubDateInput.dispatchEvent(new Event('change'));
                            }
                        }
                        document.body.removeChild(tempDateInput);
                    });
                    
                    tempDateInput.showPicker();
                });
            }
        };

        // Update Auth.checkAuth to load user data
        const originalCheckAuth = Auth.checkAuth;
        Auth.checkAuth = async () => {
            await originalCheckAuth();
            if (App.user) {
                await UI.loadUserData();
                UI.checkForOverdueBooks();
            }
        };

        // Notification System
        UI.showNotification = (message, type = 'info', duration = 5000) => {
            const container = document.getElementById('notificationContainer');
            const notificationId = 'notification-' + Date.now();
            
            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = `alert alert-${type} alert-dismissible fade show`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after duration
            setTimeout(() => {
                const notif = document.getElementById(notificationId);
                if (notif) {
                    notif.remove();
                }
            }, duration);
        };

        // Check for overdue books and show notifications
        UI.checkForOverdueBooks = () => {
            if (!App.user || !App.userCheckouts) return;
            
            const today = new Date();
            const overdueBooks = App.userCheckouts.filter(checkout => {
                if (checkout.is_returned) return false;
                const dueDate = new Date(checkout.due_date);
                return dueDate < today;
            });
            
            const dueSoonBooks = App.userCheckouts.filter(checkout => {
                if (checkout.is_returned) return false;
                const dueDate = new Date(checkout.due_date);
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                return daysDiff >= 0 && daysDiff <= 2;
            });
            
            // Show overdue notifications
            overdueBooks.forEach(checkout => {
                const daysLate = Math.ceil((today - new Date(checkout.due_date)) / (1000 * 60 * 60 * 24));
                UI.showNotification(
                    `<strong>Overdue Book!</strong> "${checkout.title}" is ${daysLate} day${daysLate === 1 ? '' : 's'} late. Please return it soon to avoid additional fees.`,
                    'danger',
                    10000
                );
            });
            
            // Show due soon notifications
            dueSoonBooks.forEach(checkout => {
                const daysLeft = Math.ceil((new Date(checkout.due_date) - today) / (1000 * 60 * 60 * 24));
                UI.showNotification(
                    `<strong>Book Due Soon!</strong> "${checkout.title}" is due in ${daysLeft} day${daysLeft === 1 ? '' : 's'}.`,
                    'warning',
                    8000
                );
            });
        };

        // Enhanced Utils.showAlert to also show notifications
        const originalShowAlert = Utils.showAlert;
        Utils.showAlert = (message, type = 'danger', containerId = 'alertContainer') => {
            originalShowAlert(message, type, containerId);
            
            // Also show as notification for success/info messages
            if (type === 'success' || type === 'info') {
                UI.showNotification(message, type);
            }
        };

        // Show all user checkouts
        UI.showAllCheckouts = async () => {
            if (!App.user) {
                Utils.showAlert('Please log in to view your checkouts.', 'warning');
                return;
            }
            
            // Set current view
            App.currentView = 'checkouts';

            document.getElementById('mainContent').innerHTML = `
                <div class="container my-4">
                    <div class="row">
                        <div class="col-12 d-flex justify-content-between align-items-center mb-3">
                            <button class="btn btn-outline-secondary back-to-dashboard-btn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </button>
                            <button class="btn btn-outline-primary refresh-checkouts-btn" id="refreshCheckoutsBtn">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                            <button class="btn btn-outline-success test-return-btn" id="testReturnBtn">
                                <i class="fas fa-test me-2"></i>Test Return
                            </button>
                        </div>
                    </div>
                    <h2><i class="fas fa-bookmark me-2"></i>My Checkouts</h2>
                    <div id="checkoutsContainer">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading checkouts...</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            try {
                const data = await Utils.makeRequest('/checkouts/user');
                const container = document.getElementById('checkoutsContainer');
                
                if (data.checkouts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                            <h5>No checkouts found</h5>
                            <p class="text-muted">You haven't borrowed any books yet.</p>
                            <button class="btn btn-primary browse-books-btn">
                                <i class="fas fa-search me-2"></i>Browse Books
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.checkouts.map(checkout => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2">
                                    <img src="${checkout.cover_image_url || 'https://via.placeholder.com/100x150?text=No+Cover'}" 
                                         class="img-fluid rounded" alt="${checkout.title}">
                                </div>
                                <div class="col-md-7">
                                    <h5 class="card-title">${checkout.title}</h5>
                                    <p class="card-text text-muted">by ${checkout.authors.join(', ')}</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <strong>Checkout Date:</strong><br>
                                                ${Utils.formatDate(checkout.checkout_date)}
                                            </small>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <strong>Due Date:</strong><br>
                                                ${Utils.formatDate(checkout.due_date)}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 text-end">
                                    ${checkout.is_returned ? `
                                        <span class="badge bg-success mb-2">Returned</span>
                                        <br>
                                        <small class="text-muted">
                                            Returned: ${Utils.formatDate(checkout.return_date)}
                                        </small>
                                        ${checkout.is_late ? `
                                            <br><small class="text-danger">Late return fee: $${checkout.late_fee}</small>
                                        ` : ''}
                                    ` : `
                                        <span class="badge ${checkout.status === 'overdue' ? 'bg-danger' : checkout.status === 'active' ? 'bg-primary' : 'bg-warning'} mb-2">
                                            ${checkout.status === 'overdue' ? 'Overdue' : checkout.status === 'active' ? 'Active' : 'Due Soon'}
                                        </span>
                                        <br>
                                        ${checkout.days_until_due !== null ? `
                                            <small class="text-muted">
                                                ${checkout.days_until_due < 0 ? 
                                                    `${Math.abs(checkout.days_until_due)} days late` : 
                                                    `${checkout.days_until_due} days left`}
                                            </small>
                                        ` : ''}
                                        <br>
                                        <button class="btn btn-warning btn-sm mt-2 return-btn" 
                                                data-book-id="${checkout.book_id}" 
                                                data-book-title="${checkout.title}">
                                            <i class="fas fa-undo me-1"></i>Return Book
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                document.getElementById('checkoutsContainer').innerHTML = 
                    '<div class="alert alert-danger">Failed to load checkouts.</div>';
            }
        };
        
        // Add cover image preview functionality
        document.addEventListener('click', async (e) => {
            if (e.target && e.target.id === 'previewCoverBtn') {
                e.preventDefault();
                const coverUrl = document.getElementById('add_cover').value.trim();
                const previewDiv = document.getElementById('coverPreview');
                const errorDiv = document.getElementById('coverError');
                const previewImg = document.getElementById('coverPreviewImg');
                
                if (!coverUrl) {
                    Utils.showAlert('Please enter an image URL first.', 'warning');
                    return;
                }
                
                try {
                    // Show loading state
                    e.target.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                    e.target.disabled = true;
                    
                    // Test the image URL
                    const response = await fetch(coverUrl, { mode: 'no-cors' });
                    
                    // Hide error if it was showing
                    errorDiv.style.display = 'none';
                    
                    // Set the image source and show preview
                    previewImg.src = coverUrl;
                    previewImg.onload = () => {
                        previewDiv.style.display = 'block';
                        e.target.innerHTML = '<i class="fas fa-eye"></i> Preview';
                        e.target.disabled = false;
                    };
                    
                    previewImg.onerror = () => {
                        throw new Error('Image failed to load');
                    };
                    
                } catch (error) {
                    // Show error
                    errorDiv.style.display = 'block';
                    previewDiv.style.display = 'none';
                    document.getElementById('coverErrorText').textContent = 
                        'Image could not be loaded. Please check the URL and try again.';
                    
                    // Reset button
                    e.target.innerHTML = '<i class="fas fa-eye"></i> Preview';
                    e.target.disabled = false;
                }
            }
        });
        
        // Clear preview when cover URL changes
        const addCoverElement = document.getElementById('add_cover');
        if (addCoverElement) {
            addCoverElement.addEventListener('input', () => {
                const previewDiv = document.getElementById('coverPreview');
                const errorDiv = document.getElementById('coverError');
                if (previewDiv) previewDiv.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'none';
            });
        }

        // Enhanced Image Loading System with Fallbacks and Retry Logic
        class ImageLoader {
            constructor() {
                this.fallbackImages = {
                    'default': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOGY4Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==',
                    'error': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZlNmU2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2QzMmEyYSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIEVycm9yPC90ZXh0Pjwvc3ZnPg==',
                    'loading': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOGY4Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzAwN2JmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvYWRpbmcuLi48L3RleHQ+PC9zdmc+'
                };
                this.imageCache = new Map();
                this.retryAttempts = new Map();
                this.maxRetries = 3;
                this.retryDelay = 1000; // 1 second
            }

            // Load image with comprehensive error handling
            async loadImage(imgElement, imageUrl, options = {}) {
                const {
                    fallbackOnError = true,
                    showLoadingState = true,
                    maxRetries = this.maxRetries,
                    onSuccess = null,
                    onError = null
                } = options;

                if (!imageUrl || imageUrl.trim() === '') {
                    this.setFallbackImage(imgElement, 'default');
                    if (onError) onError('No image URL provided');
                    return false;
                }

                // Set loading state
                if (showLoadingState) {
                    this.setFallbackImage(imgElement, 'loading');
                }

                // Check cache first
                if (this.imageCache.has(imageUrl)) {
                    imgElement.src = this.imageCache.get(imageUrl);
                    if (onSuccess) onSuccess();
                    return true;
                }

                // Show loading state
                if (showLoadingState) {
                    imgElement.src = this.fallbackImages.loading;
                }

                try {
                    const success = await this.loadImageWithRetry(imgElement, imageUrl, maxRetries);
                    if (success) {
                        // Cache successful image
                        this.imageCache.set(imageUrl, imgElement.src);
                        if (onSuccess) onSuccess();
                        return true;
                    } else {
                        throw new Error('All retry attempts failed');
                    }
                } catch (error) {
                    console.warn(`Image loading failed for ${imageUrl}:`, error.message);
                    
                    if (fallbackOnError) {
                        this.setFallbackImage(imgElement, 'error');
                    }
                    
                    if (onError) onError(error.message);
                    return false;
                }
            }

            // Load image with retry logic
            async loadImageWithRetry(imgElement, imageUrl, maxRetries) {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        const success = await this.loadSingleImage(imgElement, imageUrl);
                        if (success) return true;
                        
                        if (attempt < maxRetries) {
                            await this.delay(this.retryDelay * attempt); // Exponential backoff
                        }
                    } catch (error) {
                        console.warn(`Attempt ${attempt} failed for ${imageUrl}:`, error.message);
                        if (attempt === maxRetries) throw error;
                    }
                }
                return false;
            }

            // Load single image attempt
            loadSingleImage(imgElement, imageUrl) {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Image loading timeout'));
                    }, 10000); // 10 second timeout

                    const img = new Image();
                    
                    img.onload = () => {
                        clearTimeout(timeout);
                        imgElement.src = img.src;
                        resolve(true);
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Image failed to load'));
                    };
                    
                    // Add crossOrigin for CORS issues
                    img.crossOrigin = 'anonymous';
                    img.src = imageUrl;
                });
            }

            // Set fallback image
            setFallbackImage(imgElement, type) {
                imgElement.src = this.fallbackImages[type] || this.fallbackImages.default;
                imgElement.alt = type === 'error' ? 'Image failed to load' : 'No cover image';
            }

            // Delay utility
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // Preload images for better performance
            preloadImages(imageUrls) {
                imageUrls.forEach(url => {
                    if (url && !this.imageCache.has(url)) {
                        const img = new Image();
                        img.onload = () => this.imageCache.set(url, url);
                        img.onerror = () => {};
                        img.src = url;
                    }
                });
            }

            // Clear cache
            clearCache() {
                this.imageCache.clear();
                this.retryAttempts.clear();
            }
        }

        // Initialize global image loader
        const imageLoader = new ImageLoader();

        // Enhanced image loading function with multiple fallback strategies
        function loadBookCover(imgElement, imageUrl, options = {}) {
            return imageLoader.loadImage(imgElement, imageUrl, {
                fallbackOnError: true,
                showLoadingState: true,
                maxRetries: 3,
                onSuccess: () => {
                    console.log(`✅ Image loaded successfully: ${imageUrl}`);
                },
                onError: (error) => {
                    console.warn(`❌ Image loading failed: ${imageUrl} - ${error}`);
                    
                    // Try alternative loading approach
                    setTimeout(() => {
                        console.log(`🔄 Retrying image load with alternative method: ${imageUrl}`);
                        loadImageWithAlternativeMethod(imgElement, imageUrl);
                    }, 500);
                }
            });
        }

        // Alternative image loading method
        function loadImageWithAlternativeMethod(imgElement, imageUrl) {
            const img = new Image();
            
            img.onload = () => {
                imgElement.src = imageUrl;
                imgElement.style.opacity = '1';
            };
            
            img.onerror = () => {
                // Use a reliable fallback image
                imgElement.src = 'https://covers.openlibrary.org/b/isbn/9780061120084-L.jpg'; // To Kill a Mockingbird - known to work
                imgElement.style.opacity = '1';
            };
            
            img.src = imageUrl;
        }

        // Process all book cover images in the current view
        function processBookCoverImages() {
            const images = document.querySelectorAll('img[data-cover-url]');
            
            images.forEach((img, index) => {
                const coverUrl = img.getAttribute('data-cover-url');
                
                if (coverUrl && coverUrl.trim() !== '') {
                    // Add a small delay to ensure DOM is ready
                    setTimeout(() => {
                    loadBookCover(img, coverUrl);
                    }, index * 50); // Stagger loading by 50ms per image
                } else {
                    // Set default fallback for images without URLs
                    imageLoader.setFallbackImage(img, 'default');
                }
            });
        }

        // Enhanced image loading with mutation observer for dynamic content
        function initializeImageLoading() {
            // Process existing images
            processBookCoverImages();
            
            // Retry failed images after a delay
            setTimeout(() => {
                processBookCoverImages();
            }, 1000);
            
            // Force reload all images after a longer delay
            setTimeout(() => {
                const images = document.querySelectorAll('img[data-cover-url]');
                images.forEach((img, index) => {
                    const coverUrl = img.getAttribute('data-cover-url');
                    if (coverUrl && coverUrl.trim() !== '') {
                        // Force reload by adding timestamp
                        const urlWithTimestamp = coverUrl + (coverUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                        img.src = urlWithTimestamp;
                    }
                });
            }, 3000);
            
            // Watch for new images added to the DOM
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // Check if the added node has images
                                const images = node.querySelectorAll ? node.querySelectorAll('img[data-cover-url]') : [];
                                if (node.matches && node.matches('img[data-cover-url]')) {
                                    images.push(node);
                                }
                                
                                images.forEach(img => {
                                    const coverUrl = img.getAttribute('data-cover-url');
                                    if (coverUrl && coverUrl.trim() !== '') {
                                        loadBookCover(img, coverUrl);
                                    } else {
                                        imageLoader.setFallbackImage(img, 'default');
                                    }
                                });
                            }
                        });
                    }
                });
            });
            
            // Start observing
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
    </script>
</body>
</html>
